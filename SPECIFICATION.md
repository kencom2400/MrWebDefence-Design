# MrWebDefence 要件定義書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | MrWebDefence 要件定義書 |
| バージョン | 1.0 |
| 作成日 | 2024年 |
| 最終更新日 | 2024年 |
| 作成者 | - |

## 2. システム概要

### 2.1 目的
MrWebDefenceは、OpenAppSecをベースとしたWAF（Web Application Firewall）サービスを提供するシステムです。WebアプリケーションやAPIに対する攻撃を検知・防御し、包括的なセキュリティ保護を提供します。

### 2.2 システムの特徴
- OpenAppSecベースのWAFエンジン
- マルチテナント対応の管理画面
- 自動シグニチャ収集・更新機能
- 包括的なログ管理・分析機能
- スケーラブルなアーキテクチャ

### 2.3 対象ユーザー
- サービス管理者：WAFサービス全体の管理・運営
- サービス管理メンバー：サービス管理の一部業務を担当
- 顧客管理者：顧客向け管理画面の管理・メンバー管理
- 顧客メンバー：顧客向け管理画面での設定・監視作業

## 3. 機能要件

### 3.1 WAFエンジン

#### 3.1.1 基本機能（MUST）

**3.1.1.1 WAF機能**
- HTTP/HTTPSリクエストのリアルタイム解析
- シグニチャベースの攻撃検知
- SQLインジェクション、XSS、コマンドインジェクション等のOWASP Top 10攻撃の検知・防御
- カスタムシグニチャの適用
- 検知時のアクション（ブロック、ログ記録、アラート通知等）
- AllowList/DenyList機能
- 誤検知の回避機能（学習モード、除外設定）

**3.1.1.2 WAAP（Web Application API Protection）機能**
- REST API、GraphQL等のAPIエンドポイント保護
- APIスキーマ検証（OpenAPI/Swagger準拠）
- APIレート制限（エンドポイント単位）
- API認証・認可の検証
- 不正なAPIリクエストパターンの検知
- APIバージョニング対応

**3.1.1.3 RateLimit機能**
- リクエストレート制限（IPアドレス単位、FQDN単位、エンドポイント単位）
- 分散環境でのレート制限（Redis等の共有ストレージを使用）
- スライディングウィンドウ、トークンバケット等のアルゴリズム対応
- 動的なレート制限調整
- レート制限超過時のカスタムレスポンス
- レート制限の統計情報取得

**3.1.1.4 GeoIP Base Protection機能**
- IPアドレス/CIDRブロック機能
  - AllowList/DenyListの設定
  - 複数IP/CIDRの一括登録
  - IP範囲の管理
  - 一時的なブロック/許可（時間指定）
- 国単位のアクセス制御
  - 国コード（ISO 3166-1 alpha-2）ベースの許可/拒否
  - 複数国の一括設定
  - デフォルトポリシーの設定
- GeoIPデータベースの自動更新
- 検知ログへのGeoIP情報付与

#### 3.1.2 拡張機能（WANT）

**3.1.2.1 Anti-Bot機能**
- ボット検知（User-Agent解析、行動パターン分析）
- CAPTCHA統合
- JavaScriptチャレンジ
- ボットトラフィックの統計情報
- ボットAllowList/DenyList

**3.1.2.2 IPS（Intrusion Prevention System）機能**
- ネットワーク層での攻撃検知
- DDoS攻撃の検知・緩和
- 異常トラフィックパターンの検知
- 自動的な攻撃元IPブロック

**3.1.2.3 File Security機能**
- アップロードファイルのスキャン
- マルウェア検知
- ファイルタイプ検証
- ファイルサイズ制限
- 危険なファイル拡張子のブロック

#### 3.1.3 エンジン基盤機能

**3.1.3.1 設定管理**
- 管理画面からの設定取得（API経由）
- 設定の動的更新（再起動不要）
- 設定のバージョン管理
- 設定のロールバック機能
- 設定の検証機能

**3.1.3.2 ログ機能**
- アクセスログ（Nginx形式、JSON形式）
- WAF検知ログ（構造化ログ）
- エラーログ
- パフォーマンスログ
- ログのローテーション
- ログ管理サーバへの転送（FQDN単位）
- ログ転送の失敗時のリトライ機能

**3.1.3.3 監視・ヘルスチェック**
- ヘルスチェックエンドポイント
- **メトリクス収集**:
  - **方式**: サイドカー方式（サイドカーに監視の仕組みに合わせた収集機を設置）
  - **アプリケーション設計**: サイドカーから情報が取得できるように設計
  - **監視対象**:
    - Nginxベースのメトリクス
    - Errorログ（server単位、vhost単位のいずれも）
    - Fluentdのメトリクス
- リソース使用状況の監視
- アラート通知機能

**3.1.3.4 スケーラビリティ対応**
- 水平スケーリング対応
- 分散レート制限（Redis等を使用）
- 設定の一元管理
- ロードバランサー連携

### 3.2 管理画面

#### 3.2.1 認証・認可機能

**3.2.1.1 認証**
- ユーザーログイン機能
- セッション管理
- **パスワードポリシー**:
  - **デフォルト**: 8文字以上
  - **設定変更**: サービス管理者・サービス管理メンバーがパスワードポリシーを設定可能
    - 最小文字数
    - 複雑さ要件（大文字、小文字、数字、記号の組み合わせ）
    - パスワードの有効期限
    - 過去のパスワードの再利用制限
- **多要素認証（MFA）**:
  - **デフォルト**: オプション（ユーザーが任意で有効化可能）
  - **設定変更**: サービス管理者・サービス管理メンバーが必須/オプションを変更可能
  - **MFA設定の強制時期**: ログイン実施時に必ず発生とする
    - MFAが必須に設定されている場合、ログイン時にMFA設定を促す
    - MFAが未設定のユーザーは、ログイン後にMFA設定画面にリダイレクトされる
  - **実装方式**: TOTP（Time-based One-Time Password）
  - **対応アプリ**: Google Authenticator、Microsoft Authenticator等
  - **バックアップコード**: MFA設定時にバックアップコードを生成・表示
- パスワードリセット機能
- ログイン履歴の記録

**3.2.1.2 認可**
- ロールベースアクセス制御（RBAC）
- ユーザーロール：
  - サービス管理者：全機能へのアクセス
    - シグニチャグループの作成・編集・削除
    - シグニチャグループの適用状態設定（適用/非適用/顧客判断）
    - 全顧客のシグニチャグループ適用状況の確認
  - サービス管理メンバー：サービス管理メンバー管理・ログ管理を除く全機能
    - シグニチャグループの作成・編集・削除
    - シグニチャグループの適用状態設定（適用/非適用/顧客判断）
    - 全顧客のシグニチャグループ適用状況の確認
  - 顧客管理者：顧客向け管理画面の全機能 + 顧客メンバー管理
    - 「顧客判断」に設定されたシグニチャグループの適用/非適用設定
    - 自社のFQDNに対するシグニチャグループ設定
    - シグニチャグループの説明・メタデータの閲覧
  - 顧客メンバー：顧客向け管理画面の設定・監視機能
    - シグニチャグループの閲覧のみ（設定変更不可）
- 権限の細かい制御（拡張機能）
- APIトークン認証（拡張機能）

#### 3.2.2 サービス全体管理画面

**3.2.2.1 ダッシュボード**
- システム全体の状態表示
- アクティブなWAFエンジン数
- 全体のリクエスト数、ブロック数
- 攻撃タイプ別の統計
- リアルタイムアラート表示
- パフォーマンスメトリクス

**3.2.2.2 顧客管理**
- 顧客の登録・編集・削除
- 顧客情報の管理（名称、連絡先等）
- 顧客の有効/無効化
- 顧客ごとの利用状況表示

**3.2.2.3 ユーザー管理**
- サービス管理ユーザーの作成・編集・削除
- 顧客ユーザーの作成・編集・削除（顧客管理者権限で）
- ユーザーロールの割り当て
- ユーザーの有効/無効化
- ユーザー一覧・検索機能

**3.2.2.4 WAFエンジン管理**
- WAFエンジンの登録・編集・削除
- エンジンの状態監視
- エンジンへの設定配信
- エンジンのグループ管理
- エンジンのバージョン管理

**3.2.2.5 シグニチャ管理**
- シグニチャの一覧表示
- シグニチャの有効/無効化
- カスタムシグニチャの作成・編集・削除
- シグニチャのテスト機能
- シグニチャのバージョン管理
- 投入シグニチャ候補の確認・承認
- シグニチャ適用の履歴管理

**3.2.2.5.1 シグニチャグループ管理**
- シグニチャグループの作成・編集・削除
- グループへのシグニチャの追加・削除
- グループ単位での適用状態の設定：
  - **適用**: 全WAFエンジンに適用される
  - **非適用**: 全WAFエンジンで無効化される
  - **顧客判断**: 顧客管理者が個別に適用/非適用を判断できる
- グループの説明・メタデータ管理
- グループの優先度設定
- グループ単位での一括操作（適用/非適用/顧客判断への変更）
- グループの適用状態の一覧表示
- グループごとの適用状況の統計表示

**3.2.2.6 ログ管理**
- ログの検索・フィルタリング
- ログのエクスポート機能
- ログ分析ダッシュボード
- ログ保持期間の設定
- ログアーカイブ機能

**3.2.2.7 システム設定**
- システム全体の設定
- **通知設定**:
  - 通知チャネルの設定（メール、Slack等）
  - 通知ルールの設定（イベントタイプ、重要度等）
  - **通知の動作**:
    - 即時通知（イベント発生時に即座に通知）
    - 通知設定が何もない場合は通知は稼働しない
  - **通知の重複防止**:
    - デフォルト: 10分間（同じイベントの重複通知を防ぐ期間）
    - サービス管理者・サービス管理メンバーが管理画面上で設定可能
    - 顧客管理者が自社の設定内に限り設定可能
    - **優先度**: 顧客管理者の設定 ＞ サービス管理者の設定 ＞ デフォルト
  - **通知の失敗時のリトライ**:
    - リトライ回数: 5回
    - リトライ間隔: 指数バックオフ方式（5秒から始まり、リトライごとに間隔を倍にする）
      - 1回目: 5秒後
      - 2回目: 10秒後
      - 3回目: 20秒後
      - 4回目: 40秒後
      - 5回目: 80秒後
    - 5回のリトライ後も失敗した場合は、失敗として記録
  - **通知の優先度**: Critical, Medium, Lowの3段階
    - Critical: 緊急度が高いイベント（攻撃検知、システム障害等）
    - Medium: 重要度が中程度のイベント（警告、注意喚起等）
    - Low: 重要度が低いイベント（情報、統計情報等）
  - **通知の閲覧**:
    - サービス管理者・サービス管理メンバー: 全顧客の通知を確認可能
    - 顧客管理者・顧客メンバー: 自社の通知のみ確認可能
- ログ転送先の設定
- **バックアップ設定**:
  - バックアップの実行時間設定
  - デフォルト: 午前3時（JST）
  - サービス管理者・サービス管理メンバーが設定可能
  - バックアップの保存先設定
  - バックアップの暗号化設定
- バッチ処理スケジュール設定
  - シグニチャ検証バッチの実行時間設定
  - デフォルト: 毎日2時（JST）
  - サービス管理者・サービス管理メンバーが変更可能
- パスワードポリシー設定
  - 最小文字数、複雑さ要件等の設定
  - サービス管理者・サービス管理メンバーが設定可能

**3.2.2.8 IP AllowList管理**
- IP AllowListの登録・編集・削除
- ユーザーごと、またはロールごとにIP AllowListを設定
- **優先順位**: AllowListが絶対優先される挙動
  - AllowListに登録されているIPからのアクセスは常に許可
  - AllowListに登録されていないIPからのアクセスは拒否（DenyListの設定に関わらず）
- **デフォルト動作**: AllowListがない場合は、DenyListのみ適用
- **複数IP/CIDRの優先順位**: より具体的な範囲が優先されて適用される
  - 例：100.0.0.0/8 のルールと 100.100.0.0/16 のルールがあれば、100.100.0.0/16 のルールが優先して適用される
- **一時的なIP追加機能**: 適用期限の設定を可能とする
  - 管理画面上では相対的な書き方（10分間、1日等）で表示・設定
  - システム上ではdatetime形式で保管
- IPアドレス/CIDRブロックの一括登録
- AllowListの有効/無効化

#### 3.2.3 顧客向け管理画面

**3.2.3.1 ダッシュボード**
- 顧客のFQDNごとの状態表示
- リクエスト数、ブロック数の表示
- 攻撃タイプ別の統計
- リアルタイムアラート表示
- パフォーマンスメトリクス

**3.2.3.2 FQDN管理**
- FQDNの登録・編集・削除
- FQDNの有効/無効化
- FQDNごとの設定管理
- 複数FQDNへの一括設定適用
- FQDNグループの作成・管理

**3.2.3.3 WAF設定**
- WAFルールの設定
- シグニチャの有効/無効化（顧客レベル）
- カスタムシグニチャの作成
- AllowList/DenyListの設定
- 検知時のアクション設定

**3.2.3.4 シグニチャグループ管理（顧客向け）**
- 「顧客判断」に設定されたシグニチャグループの一覧表示
- グループごとの適用/非適用の設定
- グループ内の個別シグニチャの適用/非適用設定（オプション）
- グループの説明・メタデータの閲覧
- グループ適用状態の変更履歴表示
- FQDN単位でのシグニチャグループ適用状態の管理
- 複数FQDNへの一括適用設定

**3.2.3.5 WAAP設定**
- APIエンドポイントの登録
- APIスキーマのアップロード
- APIレート制限の設定
- API認証設定

**3.2.3.6 RateLimit設定**
- レート制限ルールの作成・編集・削除
- IP単位、エンドポイント単位の設定
- レート制限アルゴリズムの選択
- レート制限超過時のアクション設定

**3.2.3.7 GeoIP設定**
- IP/CIDRブロックリストの管理
- 国単位のアクセス制御設定
- GeoIPデータベースの更新状況確認

**3.2.3.8 IP AllowList管理（顧客向け）**
- IP AllowListの登録・編集・削除（自社FQDN向け）
- **優先順位**: AllowListが絶対優先される挙動
  - AllowListに登録されているIPからのアクセスは常に許可
  - AllowListに登録されていないIPからのアクセスは拒否（DenyListの設定に関わらず）
- **デフォルト動作**: AllowListがない場合は、DenyListのみ適用
- **複数IP/CIDRの優先順位**: より具体的な範囲が優先されて適用される
  - 例：100.0.0.0/8 のルールと 100.100.0.0/16 のルールがあれば、100.100.0.0/16 のルールが優先して適用される
- **一時的なIP追加機能**: 適用期限の設定を可能とする
  - 管理画面上では相対的な書き方（10分間、1日等）で表示・設定
  - システム上ではdatetime形式で保管
- IPアドレス/CIDRブロックの一括登録
- AllowListの有効/無効化

**3.2.3.9 ログ・監視**
- 自社FQDNのログ閲覧
- ログの検索・フィルタリング
- ログのエクスポート
- アラート設定

**3.2.3.10 通知管理（顧客向け）**
- 自社の通知設定
  - 通知チャネルの設定（メール、Slack等）
  - 通知ルールの設定（イベントタイプ、重要度等）
  - **通知の重複防止設定**:
    - 顧客管理者が自社の設定内に限り設定可能
    - サービス管理者の設定やデフォルト設定より優先される
    - 設定可能範囲: 1分～24時間
- 自社の通知履歴の閲覧
- 通知の有効/無効化

**3.2.3.11 レポート**
- 日次・週次・月次レポートの生成
- 攻撃統計レポート
- パフォーマンスレポート
- レポートの自動配信設定

### 3.3 ログ管理サーバ

#### 3.3.1 ログ収集機能
- WAFエンジンからのログ受信（HTTP、TCP、UDP等）
- ログのパース・正規化
- ログのタイムスタンプ補正
- ログのバッファリング
- ログの重複排除（拡張機能）

#### 3.3.2 ログ保存機能
- ローカルストレージへの保存
- ログのインデックス化（Elasticsearch等）
- ログの圧縮・アーカイブ
- ログ保持期間の管理
- ログの自動削除

#### 3.3.2.1 ログのアーカイブ詳細
- **決定が必要な項目**:
  - [ ] アーカイブ先の詳細（S3、その他のストレージ）
  - [ ] アーカイブの圧縮形式（gzip、その他）
  - [ ] アーカイブの暗号化の必要性
  - [ ] アーカイブからの復元機能の必要性
  - [ ] アーカイブの実行タイミング（日次、週次等）
  - [ ] アーカイブの検証方法
  - [ ] アーカイブの保持期間（1年経過後の処理）

#### 3.3.3 ログ転送機能
- 外部ログ管理システムへの転送（Splunk、Datadog等）
- クラウドストレージへの転送（S3、GCS等）
- 転送の失敗時のリトライ
- 転送の優先度設定
- 転送先の動的変更

#### 3.3.4 ログ分析機能

**3.3.4.1 攻撃分析**
- 攻撃タイプ別の集計
- 攻撃元IPの分析
- 攻撃パターンの検出
- 時系列での攻撃トレンド分析
- 地理的分布の可視化
- 攻撃の相関分析

**3.3.4.2 検知漏れ分析**
- 異常パターンの検出（機械学習ベース、拡張機能）
- 既知の攻撃パターンとの照合
- 検知漏れの可能性があるログの抽出
- 検知漏れレポートの生成

**3.3.4.3 誤検知分析**
- 誤検知の可能性があるログの抽出
- 誤検知パターンの分析
- 誤検知レポートの生成
- シグニチャ調整の提案

**3.3.4.4 ダッシュボード**
- リアルタイムダッシュボード
- カスタムダッシュボードの作成
- グラフ・チャートの表示
- アラート設定

#### 3.3.5 ログ管理サーバの監視
- **監視対象**:
  - Fluentdのメトリクス
  - ログの監視
- **監視方式**: サイドカー方式（サイドカーに監視の仕組みに合わせた収集機を設置）

### 3.4 シグニチャ収集機能

#### 3.4.1 シグニチャ生成機能
- 商用WAF機能の分析
- 脆弱性情報（CVE、セキュリティアドバイザリ）の収集
- シグニチャテンプレートからの生成
- カスタムシグニチャルールの作成
- シグニチャのメタデータ管理（説明、重要度、影響範囲等）

#### 3.4.2 シグニチャ検証機能
- 過去ログとの照合
- 誤検知率の計算
- 検知率の計算
- パフォーマンス影響の評価
- シグニチャの優先度付け

#### 3.4.3 バッチ処理機能
- **検証バッチ**: 毎日決まった時間に動作
- **検証対象**: 候補に入っていれば毎日検証される
- **検証バッチの実行時間帯**: 
  - デフォルト実行時間: 毎日2時（JST）
  - 管理画面上でサービス管理者・サービス管理メンバーが設定可能
  - 実行時間の変更は管理画面から実施可能
- **30日間の再検証サイクル**: 
  - 一度却下された候補も30日間は毎日検証される
  - **30日経過後の処理**: 自動削除
- **再検証の判定基準**:
  - 再検証での判定基準は、1回目の基準と変わらない
  - シグニチャ検証ルールについては、要検討（今後の拡張として検討）
- **再検証で良好な結果が出た場合の処理**:
  - 自動承認はしない
  - サービス管理者の承認が必要
  - 良好な結果が出た候補は承認待ち状態となり、サービス管理者が承認画面で確認・承認する
- バッチ処理のログ・監視
- **バッチ処理の失敗時のリトライ**:
  - リトライ回数: 5回
  - リトライ間隔: 指数バックオフ方式（5秒から始まり、リトライごとに間隔を倍にする）
    - 1回目: 5秒後
    - 2回目: 10秒後
    - 3回目: 20秒後
    - 4回目: 40秒後
    - 5回目: 80秒後
  - 5回のリトライ後も失敗した場合は、失敗として通知を送信
- バッチ処理の失敗時の通知

#### 3.4.4 シグニチャ管理機能
- シグニチャ候補プールの管理
- **シグニチャの承認ワークフロー**:
  - 再検証で良好な結果が出た候補は、自動承認されずに承認待ち状態となる
  - サービス管理者が承認画面で確認・承認する必要がある
  - 承認後、シグニチャ候補プールに投入される
- シグニチャの適用履歴
- シグニチャの有効/無効化
- シグニチャのバージョン管理
- **シグニチャ候補の自動削除**:
  - 30日経過後、自動的に削除される
  - 削除履歴は記録される

#### 3.4.5 シグニチャグループ機能

**3.4.5.1 シグニチャグループの概念**
- 複数のシグニチャを論理的にグループ化して管理
- グループ単位での一括操作を可能にする
- グループごとに異なる適用ポリシーを設定可能

**3.4.5.2 グループの適用状態**
- **適用（Applied）**: 
  - サービス管理者が設定
  - 全WAFエンジンに自動適用される
  - 顧客管理者は変更不可
- **非適用（Not Applied）**: 
  - サービス管理者が設定
  - 全WAFエンジンで無効化される
  - 顧客管理者は変更不可
- **顧客判断（Customer Decision）**: 
  - サービス管理者が設定
  - 顧客管理者が個別に適用/非適用を判断できる
  - 顧客ごと、またはFQDNごとに異なる設定が可能

**3.4.5.3 グループ管理機能（サービス管理者）**
- グループの作成・編集・削除
  - **削除時の動作**:
    - 基本動作: 適用されているグループの削除はできない（エラーを返す）
    - 強制削除オプション: チェックボックスを入れて強制削除が可能
    - 強制削除時の処理:
      - 利用されているシグニチャグループを削除
      - 含まれているシグニチャを個別に登録（シグニチャ自体は削除されない）
      - 削除履歴を記録
- グループへのシグニチャの追加・削除
- グループの適用状態の設定（適用/非適用/顧客判断）
- グループの優先度設定
- グループの説明・メタデータ管理
- グループ単位での一括操作
- グループごとの適用状況の統計表示
- 顧客別の適用状況の確認

**3.4.5.4 グループ管理機能（顧客管理者）**
- 「顧客判断」に設定されたグループの一覧表示
- グループごとの適用/非適用の設定
- 顧客全体への適用設定
- FQDN単位での適用設定
- 複数FQDNへの一括適用設定
- グループの説明・メタデータの閲覧
- 適用状態の変更履歴表示

**3.4.5.5 適用の優先順位**
- サービス管理者が「適用」に設定したグループは、顧客管理者の設定に関わらず常に適用される
- サービス管理者が「非適用」に設定したグループは、顧客管理者の設定に関わらず常に無効化される
- 「顧客判断」グループは、顧客管理者の設定に従って適用/非適用が決定される
- 同一シグニチャが複数のグループに含まれている場合、いずれかのグループで「適用」であれば適用される

**3.4.5.6 グループの継承とオーバーライド**
- 顧客レベルでの設定が、FQDNレベルでの設定のデフォルト値となる
- FQDNレベルでの設定が、顧客レベルの設定をオーバーライド可能
- 設定の継承関係を可視化

## 4. 非機能要件

### 4.1 パフォーマンス要件
- WAFエンジンのレイテンシ：平均10ms以下（P95: 50ms以下）
- 管理画面の応答時間：平均500ms以下
- ログ転送の遅延：5秒以内
- 同時接続数：10,000接続/エンジン
- スループット：10,000リクエスト/秒/エンジン

### 4.1.1 キャッシュ戦略
- **対象**: 以下のデータをキャッシュ対象とする
  - ユーザーセッション情報（Redis）
  - シグニチャグループ一覧（Redis）
  - 顧客情報（Redis）
  - FQDN設定情報（Redis）
  - シグニチャ情報（Redis）
- **キャッシュの無効化**: データ更新時に適切に無効化
- **キャッシュの監視**: キャッシュヒット率の監視

### 4.1.2 データベース接続プール設定
- **デフォルト**: 5本の接続プール
- **設定方法**: 開発者がconf等の設定ファイルで設定可能
- **設定項目**:
  - 最小接続数
  - 最大接続数
  - 接続のタイムアウト設定
  - 接続のアイドルタイムアウト

### 4.1.3 データベース選定
- **データベース**: MySQL（最新バージョン）
- **文字コード**: Unicode/Japanをベース（UTF-8、UTF-8MB4等）
- **マイグレーション戦略**:
  - マイグレーションツールを使用してスキーマ及びその変更を管理
  - スキーマのバージョン管理
  - マイグレーションの実行履歴管理

### 4.2 可用性要件
- システム稼働率：99.9%以上
- 計画メンテナンス時間：月次4時間以内
- 自動フェイルオーバー機能
- データベースのレプリケーション
- バックアップ・リストア機能

### 4.3 スケーラビリティ要件
- 水平スケーリング対応
- エンジン数の動的追加・削除
- ロードバランサー連携
- 分散レート制限対応
- データベースのスケーリング対応

### 4.4 セキュリティ要件
- 通信の暗号化（TLS 1.2以上）
- 認証情報の安全な保存（ハッシュ化、ソルト）
- SQLインジェクション対策
- XSS対策
- CSRF対策
- セッション管理の安全性
- ログの機密情報マスキング
- 監査ログの記録

### 4.5 運用性要件
- ログの構造化（JSON形式）
- メトリクスの収集（Prometheus形式）
- アラート通知機能
- ダッシュボードでの可視化
- 設定のバージョン管理
- ロールバック機能

### 4.6 互換性要件
- Dockerコンテナ対応
- Kubernetes対応（拡張機能）
- 主要なLinuxディストリビューション対応
- 主要なWebサーバー連携（Nginx、Apache等）

### 4.7 保守性要件
- モジュール化された設計
- APIファーストアーキテクチャ
- プラグインアーキテクチャ（拡張機能）
- ドキュメントの整備
- テストカバレッジ：
  - 全体：80%以上
  - 個別モジュール：70%以上

## 5. システム構成

### 5.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                     管理画面（Web UI）                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ サービス全体  │  │ 顧客向け管理  │  │ 認証・認可    │      │
│  │ 管理画面      │  │ 画面          │  │ サービス      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   管理API（REST API）                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 設定管理API   │  │ ユーザー管理  │  │ ログ取得API   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    バックエンドサービス                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 設定管理      │  │ シグニチャ    │  │ ユーザー管理  │      │
│  │ サービス      │  │ 収集サービス  │  │ サービス      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      データストア                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ リレーショナル│  │ キャッシュ    │  │ オブジェクト │      │
│  │ DB（MySQL）   │  │ （Redis）     │  │ ストレージ    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    WAFエンジン（Docker）                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Nginx         │  │ OpenAppSec   │  │ 設定取得     │      │
│  │               │  │              │  │ エージェント  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │ ログ転送      │  │ レート制限    │                        │
│  │ エージェント  │  │ （Redis連携） │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    ログ管理サーバ                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ ログ収集      │  │ ログ分析      │  │ ログ転送      │      │
│  │ サービス      │  │ エンジン      │  │ サービス      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 技術スタック（提案）

**管理画面（フロントエンド）**
- フレームワーク：React / Vue.js / Next.js
- UIライブラリ：Material-UI / Ant Design / Tailwind CSS
- 状態管理：Redux / Zustand / Pinia
- ビルドツール：Vite / Webpack

**管理API（バックエンド）**
- 言語：Go / Python（FastAPI） / Node.js（TypeScript）
- フレームワーク：Gin / FastAPI / Express
- ORM：SQLAlchemy 2.0（Python FastAPIの場合）/ GORM（Goの場合）/ Prisma（Node.jsの場合）
  - MySQL対応のORMを使用

**データストア**
- リレーショナルDB：MySQL（最新バージョン）
  - 文字コード：Unicode/Japanをベース（UTF-8、UTF-8MB4等）
  - マイグレーションツール：スキーマ及びその変更を管理
- キャッシュ：Redis
- オブジェクトストレージ：MinIO / S3（拡張）

**WAFエンジン**
- ベース：OpenAppSec
- Webサーバー：Nginx
- コンテナ：Docker
- オーケストレーション：Docker Compose / Kubernetes（拡張）

**ログ管理サーバ**
- ログ収集：Fluentd / Fluent Bit / Vector
- ログ分析：Elasticsearch / ClickHouse（拡張）
- 可視化：Grafana / Kibana（拡張）

**その他**
- メッセージキュー：RabbitMQ / Apache Kafka（拡張）
- 監視：Prometheus + Grafana
- CI/CD：GitHub Actions / GitLab CI

### 5.3 データモデル（主要エンティティ）

**ユーザー関連**
- users（ユーザー）
- roles（ロール）
- user_roles（ユーザー・ロール関連）
- sessions（セッション）

**顧客・FQDN関連**
- customers（顧客）
- fqdns（FQDN）
- fqdn_groups（FQDNグループ）
- fqdn_group_members（FQDNグループメンバー）

**WAFエンジン関連**
- waf_engines（WAFエンジン）
- engine_groups（エンジングループ）
- engine_configurations（エンジン設定）
- configuration_versions（設定バージョン）

**シグニチャ関連**
- signatures（シグニチャ）
  - id, name, description, content, version, created_at, updated_at, status
- signature_candidates（シグニチャ候補）
  - id, signature_id, name, description, content, status, verification_result, first_verified_at, last_verified_at, created_at, updated_at
- signature_rules（シグニチャルール）
  - id, signature_id, rule_type, rule_content
- signature_applications（シグニチャ適用履歴）
  - id, signature_id, applied_at, applied_by, status
- signature_groups（シグニチャグループ）
  - id, name, description, application_status (適用/非適用/顧客判断), priority, created_at, updated_at, created_by
- signature_group_members（シグニチャグループメンバー）
  - id, group_id, signature_id, order, created_at
- signature_group_applications（シグニチャグループ適用状態）
  - id, group_id, application_status, changed_at, changed_by, notes
- customer_signature_group_settings（顧客別シグニチャグループ設定）
  - id, customer_id, fqdn_id (nullable), group_id, application_status (適用/非適用), applied_at, applied_by, notes

**設定関連**
- waf_settings（WAF設定）
- rate_limit_rules（レート制限ルール）
- geoip_rules（GeoIPルール）
- ip_allowlist（IP AllowList）
- ip_denylist（IP DenyList）
- batch_schedules（バッチスケジュール設定）
- password_policy（パスワードポリシー設定）

**ログ関連**
- access_logs（アクセスログ）
- waf_detection_logs（WAF検知ログ）
- log_analyses（ログ分析結果）

### 5.4 API設計（主要エンドポイント）

**APIバージョニングポリシー**
- APIバージョンはパスに含める形式（例：`/api/v1/...`）
- 破壊的変更が発生しない限り、v1から以降のバージョンは発生しない
- 後方互換性を維持する設計

**APIレート制限**
- **基本方針**: セキュリティ対策として、認証エンドポイント等の機微なエンドポイントにはレート制限を実装
- **認証エンドポイント**: ログイン試行回数の制限（例: 5回/分/IP）
- **その他のエンドポイント**: 初期実装ではレート制限なし（将来拡張として検討）
- **実装方式**: Redisを使用した分散レート制限

**認証API**
- POST /api/v1/auth/login
- POST /api/v1/auth/logout
- POST /api/v1/auth/refresh
- GET /api/v1/auth/me

**顧客管理API**
- GET /api/v1/customers
- POST /api/v1/customers
- GET /api/v1/customers/{id}
- PUT /api/v1/customers/{id}
- DELETE /api/v1/customers/{id}

**FQDN管理API**
- GET /api/v1/fqdns
- POST /api/v1/fqdns
- GET /api/v1/fqdns/{id}
- PUT /api/v1/fqdns/{id}
- DELETE /api/v1/fqdns/{id}

**WAF設定API**
- GET /api/v1/fqdns/{id}/waf-settings
- PUT /api/v1/fqdns/{id}/waf-settings
- GET /api/v1/waf-settings/templates

**シグニチャ管理API**
- GET /api/v1/signatures
- POST /api/v1/signatures
- GET /api/v1/signatures/{id}
- PUT /api/v1/signatures/{id}
- DELETE /api/v1/signatures/{id}
- GET /api/v1/signature-candidates
- POST /api/v1/signature-candidates/{id}/approve

**シグニチャグループ管理API（サービス管理者用）**
- GET /api/v1/signature-groups
- POST /api/v1/signature-groups
- GET /api/v1/signature-groups/{id}
- PUT /api/v1/signature-groups/{id}
- DELETE /api/v1/signature-groups/{id}
  - クエリパラメータ: `?force=true` で強制削除（チェックボックス相当）
  - 適用中のグループは通常削除不可（エラー403を返す）
  - 強制削除時は含まれるシグニチャを個別登録してからグループを削除
- POST /api/v1/signature-groups/{id}/members
- DELETE /api/v1/signature-groups/{id}/members/{signature_id}
- PUT /api/v1/signature-groups/{id}/application-status
- GET /api/v1/signature-groups/{id}/application-status
- GET /api/v1/signature-groups/{id}/statistics

**シグニチャグループ管理API（顧客管理者用）**
- GET /api/v1/customers/{customer_id}/signature-groups
- GET /api/v1/customers/{customer_id}/signature-groups/{group_id}
- PUT /api/v1/customers/{customer_id}/signature-groups/{group_id}/application-status
- PUT /api/v1/fqdns/{fqdn_id}/signature-groups/{group_id}/application-status
- GET /api/v1/fqdns/{fqdn_id}/signature-groups

**ログAPI**
- GET /api/v1/logs/access
- GET /api/v1/logs/detection
- GET /api/v1/logs/analytics
- **注意**: ログ検索機能の詳細は後で決定

**IP AllowList管理API**
- GET /api/v1/ip-allowlist
- POST /api/v1/ip-allowlist
- GET /api/v1/ip-allowlist/{id}
- PUT /api/v1/ip-allowlist/{id}
- DELETE /api/v1/ip-allowlist/{id}
- GET /api/v1/ip-allowlist/users/{user_id}
- GET /api/v1/ip-allowlist/roles/{role_id}

**バッチスケジュール管理API**
- GET /api/v1/batch-schedules
- PUT /api/v1/batch-schedules/{schedule_type} -- schedule_type: signature_verification等
- GET /api/v1/batch-schedules/{schedule_type}

**通知管理API（サービス管理者用）**
- GET /api/v1/notification-channels
- POST /api/v1/notification-channels
- GET /api/v1/notification-channels/{id}
- PUT /api/v1/notification-channels/{id}
- DELETE /api/v1/notification-channels/{id}
- GET /api/v1/notification-rules
- POST /api/v1/notification-rules
- GET /api/v1/notification-rules/{id}
- PUT /api/v1/notification-rules/{id}
- DELETE /api/v1/notification-rules/{id}
- GET /api/v1/notifications -- 全顧客の通知履歴
- GET /api/v1/notifications/customers/{customer_id} -- 特定顧客の通知履歴

**通知管理API（顧客管理者用）**
- GET /api/v1/customers/{customer_id}/notification-channels
- POST /api/v1/customers/{customer_id}/notification-channels
- GET /api/v1/customers/{customer_id}/notification-rules
- POST /api/v1/customers/{customer_id}/notification-rules
- GET /api/v1/customers/{customer_id}/notifications -- 自社の通知履歴

**パスワードポリシー管理API**
- GET /api/v1/password-policy
- PUT /api/v1/password-policy

**WAFエンジンAPI（エンジン側）**
- GET /engine/v1/config
- POST /engine/v1/logs
- GET /engine/v1/health
- GET /engine/v1/metrics

## 6. 拡張性の考慮

### 6.1 プラグインアーキテクチャ
- カスタムシグニチャエンジンの追加
- カスタム分析モジュールの追加
- 外部システム連携プラグイン
- 通知チャネルの拡張

### 6.2 マイクロサービス化
- サービス間の疎結合設計
- API Gatewayの導入
- サービスメッシュ対応（Istio等）
- イベント駆動アーキテクチャ

### 6.3 マルチクラウド対応
- クラウドプロバイダー抽象化レイヤー
- クラウド固有機能のプラグイン化
- ハイブリッドクラウド対応

### 6.4 機械学習・AI機能
- 異常検知の機械学習化
- 自動シグニチャ生成のAI化
- 攻撃パターン予測
- 適応的レート制限

### 6.5 国際化対応
- **多言語対応**: 英語のみ対応（初版）
- **デザイン要件**: 英語表記にも耐えられるデザインが必要
  - 長い英語テキストに対応したレイアウト
  - 文字数が多くなることを想定したUI設計
- タイムゾーン対応

### 6.6 統合機能
- SIEM連携
- チケットシステム連携（Jira、ServiceNow等）
- チャットツール連携（Slack、Microsoft Teams等）
- 通知チャネルの拡張（SNS、メール、Webhook等）

## 7. セキュリティ要件（詳細）

### 7.1 認証・認可
- パスワードポリシー（最小長、複雑さ要件）
- アカウントロックアウト機能
- セッションタイムアウト
- 多要素認証（MFA）対応
- OAuth 2.0 / SAML対応（拡張機能）
- APIキー認証

### 7.2 データ保護
- 暗号化（保存時、転送時）
- 機密情報のマスキング
- データバックアップの暗号化
- 個人情報保護（GDPR、個人情報保護法対応）

### 7.3 監査・ログ
- 全操作の監査ログ記録
- ログの改ざん防止
- ログの長期保存
- 監査レポートの生成

### 7.4 脆弱性管理
- 定期的なセキュリティスキャン
- 依存関係の脆弱性チェック
- セキュリティパッチの適用
- ペネトレーションテスト

## 8. 運用要件

### 8.1 デプロイメント
- **実装範囲**: Dockerベースでイメージを作成するところまでが開発の範疇
- **イメージ管理・デプロイメント**: 利用者の状況に合わせて決定（本開発のスコープ外）
- コンテナベースのデプロイメント
- Dockerイメージの作成
- デプロイメント戦略（ブルー・グリーン、カナリアリリース等）は利用者が決定

### 8.2 監視・アラート

#### 8.2.1 監視アーキテクチャ
- **サイドカー方式**: サイドカーに監視の仕組みに合わせた収集機を設置する方針
- **アプリケーション設計**: サイドカーから情報が取得できるように設計

#### 8.2.2 監視対象
- **WAFエンジン**:
  - Nginxベースのメトリクス
  - Errorログ（server単位、vhost単位のいずれも）
  - Fluentdのメトリクス
- **管理画面**:
  - Nginxベースのメトリクス
  - アプリケーションのメトリクス・ログ
- **ログ管理サーバ**:
  - Fluentdのメトリクス
  - ログの監視

#### 8.2.3 監視機能
- ヘルスチェック
- メトリクス収集（Prometheus形式）
- ログ集約
- アラート通知
- ダッシュボード

### 8.3 バックアップ・リストア
- **データベースの定期バックアップ**:
  - 実行時間: デフォルト午前3時（JST）
  - 設定変更: サービス管理者・サービス管理メンバーが設定可能
  - 日次フルバックアップ + バイナリログ（binlog）によるポイントインタイムリカバリ（PITR）対応
- **設定のバックアップ**: Gitでバージョン管理
- **バックアップの検証**: 定期的な検証
- **リストア手順の整備**: 手順書の作成

### 8.4 ドキュメント
- **詳細設計書**: モジュール単位で作成
- APIドキュメント（OpenAPI/Swagger）
- 運用マニュアル
- トラブルシューティングガイド
- ユーザーマニュアル

### 8.5 テスト戦略
- **テストカバレッジ**:
  - 全体：80%以上
  - 個別モジュール：70%以上
- **テスト種類**:
  - ユニットテスト（Unit Test）
  - E2Eテスト（End-to-End Test）
  - Lint（コード品質チェック）
- **テスト環境**:
  - Local環境で稼働させるためのスクリプトを用意
  - GitHub Actions上でCIを稼働させる

## 9. 制約事項・前提条件

### 9.1 技術的制約
- OpenAppSecベースでの実装
- Dockerコンテナでの動作
- Nginxとの連携

### 9.2 スコープ外
- ロードバランサーの実装（既存LBの利用を想定）
- クラウドインフラの構築（既存インフラの利用を想定）
- ハードウェアの調達

### 9.3 前提条件
- Docker環境の整備
- ネットワーク環境の整備
- データベースサーバーの準備（MySQL最新バージョン、Unicode/Japan対応）
- ログ管理サーバーの準備

## 10. 今後の検討事項

### 10.1 機能拡張
- 機械学習ベースの異常検知
- 自動インシデント対応
- セキュリティレポートの自動生成
- コンプライアンスレポート機能

### 10.2 パフォーマンス最適化
- キャッシュ戦略の最適化
- データベースクエリの最適化
- CDN連携
- エッジコンピューティング対応

### 10.3 ユーザビリティ向上
- モバイルアプリ対応
- リアルタイム通知機能
- カスタマイズ可能なダッシュボード
- ワークフロー自動化

### 10.4 ライセンス・コンプライアンス要件
- **初版での考慮**: 一旦考慮しない（DECISION_POINTS.mdと統一）
  - プロジェクトのライセンス、オープンソースライブラリの選定基準、セキュリティ監査の実施範囲に関する将来的な検討事項は本開発のスコープ外
- **将来的な検討事項**: 
  - セキュリティ製品として、利用するオープンソースのライセンス遵守は法務・セキュリティリスクの観点から重要
  - 初版リリース前に、利用するOSSのライセンスを洗い出し、問題がないか確認するプロセスを計画に含めることを推奨
  - GDPR等のコンプライアンス要件への対応
  - データの保存場所の制約
  - データの暗号化要件
  - 詳細なライセンス監査の実施

## 11. 用語集

| 用語 | 説明 |
|------|------|
| WAF | Web Application Firewall（Webアプリケーションファイアウォール） |
| WAAP | Web Application API Protection（WebアプリケーションAPI保護） |
| FQDN | Fully Qualified Domain Name（完全修飾ドメイン名） |
| CIDR | Classless Inter-Domain Routing（クラスレスドメイン間ルーティング） |
| GeoIP | Geographic IP（地理的IP情報） |
| IPS | Intrusion Prevention System（侵入防止システム） |
| SIEM | Security Information and Event Management（セキュリティ情報イベント管理） |
| RBAC | Role-Based Access Control（ロールベースアクセス制御） |
| MFA | Multi-Factor Authentication（多要素認証） |

## 12. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0 | 2024年 | 初版作成 | - |

