# PR作成・レビューフェーズ

## 4️⃣ PR作成・レビューフェーズ

### 📤 PR作成ワークフロー

**🚨 CRITICAL: PR作成は必須**

- ❌ **mainブランチへの直接push・コミットは絶対禁止**
- ✅ **すべての変更は必ずPRを経由してmainにマージ**
- ✅ PRが承認・マージされるまでIssueはIn Progressのまま

**自動化されたフロー:**

1. **フィーチャーブランチにpush後**: PRを作成
2. **追加のpush時**: PR本文を自動更新（必要に応じて）
3. **レビュー依頼**: 必要に応じてレビュアーを指定
4. **PR承認後**: mainにマージ
5. **マージ後のみ**: IssueをDoneに変更

**PR作成前チェック:**

- [ ] 現在のブランチがmainではないことを確認（`git branch`）
- [ ] すべての変更がコミット済み
- [ ] push前のローカルチェックを完了（lint/test/e2e）
- [ ] テストが通ることを確認
- [ ] コンフリクトが発生していないか確認

**参照ルール:**

- **`.cursor/rules/03-git-workflow.d/04-pr-review.md`** - PR作成・レビュー対応

### 🔍 CI確認と対応

**PR作成後の自動確認:**

1. CIステータスの確認（30-60秒待機後）
2. エラー発生時の原因究明
3. 自分の修正によるエラー → 即座に修正
4. 既存のエラー → Issue作成

**参照ルール:**

- **`.cursor/rules/03-git-workflow.d/04-pr-review.md`** - CI確認・エラー対応

### 🤖 Gemini Code Assistレビュー対応

**🚨 CRITICAL: レビュー対応の絶対ルール**

- [ ] すべての指摘に必ず対応する（見落とし禁止）
- [ ] 1つの指摘に対して、1 commitで対応する
- [ ] すべての指摘対応完了後、PRコメントで返信する
- [ ] 関連するIssueにもコメントする（必須）

#### レビューコメント確認手順

1. **レビューコメントの取得**
   ```bash
   # PRのレビューコメントを確認
   gh pr view <PR_NUMBER> --json reviews --jq '.reviews[] | select(.author.login == "gemini-code-assist") | .body'
   
   # ファイルごとのコメントを確認
   gh api repos/<OWNER>/<REPO>/pulls/<PR_NUMBER>/comments --jq '.[] | select(.user.login == "gemini-code-assist")'
   ```

2. **指摘事項の整理**
   - レビューコメントを読み、指摘事項をリスト化
   - 各指摘の重要度と対応優先順位を決定
   - ToDoリストを作成（`todo_write`ツールを使用）

3. **対応方針の決定**
   - 各指摘に対して対応方法を検討
   - 必要に応じて、設計変更やリファクタリングを検討
   - 対応順序を決定

#### レビュー対応のベストプラクティス

**1. ToDoリストの作成**
- レビューコメントを確認後、まずToDoリストを作成
- 各指摘を個別のタスクとして管理
- 対応順序を明確にする

**2. 段階的な対応**
- 1つの指摘に対して、1つのコミットで対応
- 複数の指摘がある場合は、順番に対応
- 各対応後に動作確認を実施

**3. コミットメッセージ**
- 指摘内容を明確に記載
- 対応内容を簡潔に説明
- 例: `fix: Geminiレビュー指摘に対応 - 設定の重複問題を解決`

**4. 対応完了後の確認**
- すべての指摘に対応したことを確認
- 動作確認を実施
- PRコメントで対応内容を報告

**5. PRコメントでの返信**
- 各指摘に対する対応内容を説明
- 対応したコミットへのリンクを記載
- 必要に応じて、対応しなかった理由を説明

#### よくある指摘パターンと対応方法

**設定の重複**
- **指摘**: 複数の設定ファイルに同じ設定が存在
- **対応**: Single Source of Truthを確立し、設定を一元化

**ドキュメントの不足**
- **指摘**: 設定の優先順位や使用方法が不明確
- **対応**: ドキュメントに詳細な説明を追加

**コードの構造**
- **指摘**: コードの構造や設計に関する提案
- **対応**: 提案を検討し、必要に応じてリファクタリング

**セキュリティ**
- **指摘**: セキュリティ上の懸念
- **対応**: 即座に対応し、セキュリティベストプラクティスに準拠

#### 対応例

```bash
# 1. レビューコメントを確認
gh pr view 21 --json reviews

# 2. ToDoリストを作成
# (todo_writeツールを使用)

# 3. 各指摘に対応
# - 設定の重複問題を解決
git add config/projects/mrwebdefence-design.yaml scripts/jira/config.sh
git commit -m "fix: Geminiレビュー指摘に対応 - 設定の重複問題を解決"

# 4. 対応完了をPRコメントで報告
gh pr comment 21 --body "## ✅ Geminiレビュー指摘への対応完了

以下の指摘に対応しました:

1. **設定の重複問題**
   - config/projects/*.yamlをSingle Source of Truthとして使用
   - config.shを修正し、YAMLファイルから設定を読み込むように変更

2. **ドキュメントの明確化**
   - JIRA_SETUP.mdに設定の優先順位を追加
   - Single Source of Truthの説明を追加

3. **YAML設定ファイルの改善**
   - コメントを追加し、構造を明確化

すべての指摘に対応しました。レビューをお願いします。"
```
