# MrWebDefence Epic・タスク設計書

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| 作成日 | 2024年 |
| 最終更新日 | 2024年 |
| 目的 | Epicとタスクの設計を定義し、実装計画を明確化する |

## リポジトリ構成

| リポジトリ名 | 言語 | 主な責務 |
|------------|------|---------|
| MrWebDefence-Design | shell | 設計・ドキュメント管理 |
| MrWebDefence-Engine | shell | WAFエンジン（OpenAppSec統合） |
| MrWebDefence-Console | typescript | 管理画面（フロントエンド・バックエンド） |
| MrWebDefence-SignatureCollector | typescript | シグニチャ収集・検証機能 |
| MrWebDefence-LogServer | ruby | ログ管理サーバ |

---

## Epic一覧

### Epic 1: システムアーキテクチャ設計
**リポジトリ**: MrWebDefence-Design

### Epic 2: データベース設計・実装
**リポジトリ**: MrWebDefence-Design, MrWebDefence-Console

### Epic 3: 認証・認可機能実装
**リポジトリ**: MrWebDefence-Console

### Epic 4: 管理画面基本機能実装
**リポジトリ**: MrWebDefence-Console

### Epic 5: WAFエンジン基盤実装
**リポジトリ**: MrWebDefence-Engine

### Epic 6: シグニチャ管理機能実装
**リポジトリ**: MrWebDefence-Console, MrWebDefence-Engine

### Epic 7: シグニチャ収集機能実装
**リポジトリ**: MrWebDefence-SignatureCollector

### Epic 8: ログ管理サーバ実装
**リポジトリ**: MrWebDefence-LogServer

### Epic 9: 通知機能実装
**リポジトリ**: MrWebDefence-Console

### Epic 10: バックアップ・リストア機能実装
**リポジトリ**: MrWebDefence-Console

### Epic 11: 監視・メトリクス機能実装
**リポジトリ**: 全リポジトリ

### Epic 12: テスト環境構築
**リポジトリ**: 全リポジトリ

---

## Epic詳細

### Epic 1: システムアーキテクチャ設計

#### なぜやるか
システム全体のアーキテクチャを明確にし、各コンポーネント間の関係性、データフロー、通信プロトコルを定義する必要がある。これにより、実装時の一貫性を保ち、将来の拡張性を確保する。

#### 何をやるか（概要）
- システム全体アーキテクチャの設計
- コンポーネント間の関係性定義
- データフロー設計
- 通信プロトコル定義
- セキュリティ境界の明確化

#### 受け入れ条件
- [ ] システム全体アーキテクチャ図が完成している
- [ ] コンポーネント間の通信プロトコルが定義されている
- [ ] データフロー図が完成している
- [ ] セキュリティ境界が明確に定義されている
- [ ] 設計ドキュメントがDESIGN.mdに反映されている

#### 詳細
- モノリシックアーキテクチャを採用（初版）
- APIファースト設計
- 水平スケーリング対応
- 将来のマイクロサービス化を考慮した設計

#### タスク一覧

##### Task 1.1: システム全体アーキテクチャ図作成
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
システム全体の構成を可視化し、開発チーム全体で共有する必要がある。

**何をやるか（概要）**
- 管理画面、WAFエンジン、ログ管理サーバ、シグニチャ収集機能の4つの主要コンポーネントの関係性を図示
- 各コンポーネントの責務を明確化
- データストア（MySQL、Redis）との関係性を定義

**受け入れ条件**
- [ ] システム全体アーキテクチャ図が完成している
- [ ] 各コンポーネントの責務が明確に定義されている
- [ ] DESIGN.mdの3.1.3に反映されている

##### Task 1.2: データフロー設計
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
設定配信、ログ転送、認証などの主要なデータフローを明確にし、実装時の整合性を保つ必要がある。

**何をやるか（概要）**
- 設定配信フローの設計
- ログ転送フローの設計
- 認証フローの設計
- 各フローの詳細なシーケンス図作成

**受け入れ条件**
- [ ] 主要なデータフローが全て定義されている
- [ ] シーケンス図が完成している
- [ ] DESIGN.mdの3.1.3.3に反映されている

##### Task 1.3: 通信プロトコル定義
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
各コンポーネント間の通信方法を統一し、セキュリティ要件を満たす必要がある。

**何をやるか（概要）**
- コンポーネント間の通信プロトコル定義（HTTPS、HTTP、MySQL Protocol、Redis Protocol）
- ポート番号の定義
- 認証方式の定義
- 通信プロトコル一覧表の作成

**受け入れ条件**
- [ ] 全てのコンポーネント間の通信プロトコルが定義されている
- [ ] ポート番号が明確に定義されている
- [ ] 認証方式が明確に定義されている
- [ ] DESIGN.mdの3.1.3.4に反映されている

##### Task 1.4: セキュリティ境界定義
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
セキュリティ境界を明確にし、適切なセキュリティ対策を実装する必要がある。

**何をやるか（概要）**
- 外部境界、内部境界、データ境界の定義
- 各境界でのセキュリティ要件の明確化
- セキュリティ境界図の作成

**受け入れ条件**
- [ ] セキュリティ境界が明確に定義されている
- [ ] 各境界でのセキュリティ要件が明確化されている
- [ ] DESIGN.mdの3.1.3.5に反映されている

---

### Epic 2: データベース設計・実装

#### なぜやるか
データベースはシステム全体の基盤となるため、適切な設計と実装が必要。MySQL 8.4系を使用し、utf8mb4文字コードで実装する必要がある。

#### 何をやるか（概要）
- ER図の作成
- テーブル定義書の作成
- Flywayを使用したマイグレーション設計
- データベース初期化スクリプトの実装

#### 受け入れ条件
- [ ] ER図が完成している
- [ ] 全テーブルの定義書が完成している
- [ ] Flywayマイグレーションファイルが作成されている
- [ ] データベース初期化スクリプトが動作する
- [ ] 設計ドキュメントがDESIGN.mdに反映されている

#### 詳細
- MySQL 8.4系を使用
- utf8mb4文字コード
- Flywayを使用したマイグレーション管理
- 接続プール: デフォルト5本、最大接続数100

#### タスク一覧

##### Task 2.1: ER図作成
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
エンティティ間の関係性を可視化し、データベース設計の整合性を保つ必要がある。

**何をやるか（概要）**
- ユーザー関連エンティティのER図作成
- 顧客・FQDN関連エンティティのER図作成
- シグニチャ関連エンティティのER図作成
- その他関連エンティティのER図作成

**受け入れ条件**
- [ ] 主要なエンティティのER図が完成している
- [ ] エンティティ間の関係性が明確に定義されている
- [ ] DESIGN.mdの3.2.3に反映されている

##### Task 2.2: テーブル定義書作成
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
各テーブルの詳細な定義を明確にし、実装時の整合性を保つ必要がある。

**何をやるか（概要）**
- 全テーブルのカラム定義（型、制約、インデックス）
- 外部キー制約の定義
- ユニーク制約の定義
- インデックス戦略の定義

**受け入れ条件**
- [ ] 全テーブルの定義書が完成している
- [ ] カラムの型、制約が明確に定義されている
- [ ] インデックスが適切に定義されている
- [ ] DESIGN.mdの3.2.4に反映されている

##### Task 2.3: Flywayマイグレーション設計
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
データベーススキーマのバージョン管理とマイグレーション管理を適切に行う必要がある。

**何をやるか（概要）**
- Flywayマイグレーションファイルの命名規則定義
- マイグレーション実行タイミングの定義
- ロールバック戦略の定義
- マイグレーション実行履歴管理方法の定義

**受け入れ条件**
- [ ] Flywayマイグレーション設計が完成している
- [ ] 命名規則が明確に定義されている
- [ ] ロールバック戦略が明確に定義されている
- [ ] DESIGN.mdの3.2.7に反映されている

##### Task 2.4: データベース初期化スクリプト実装
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
開発環境やCI環境でデータベースを簡単に初期化できるようにする必要がある。

**何をやるか（概要）**
- MySQL 8.4系のセットアップスクリプト作成
- utf8mb4文字コード設定
- Flywayマイグレーション実行スクリプト作成
- 初期データ投入スクリプト作成（オプション）

**受け入れ条件**
- [ ] データベース初期化スクリプトが動作する
- [ ] utf8mb4文字コードが正しく設定される
- [ ] Flywayマイグレーションが正常に実行される
- [ ] スクリプトがドキュメント化されている

##### Task 2.5: データベース接続プール実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
データベース接続を効率的に管理し、パフォーマンスを最適化する必要がある。

**何をやるか（概要）**
- データベース接続プールの実装（デフォルト5本）
- 接続タイムアウト設定（デフォルト10秒）
- 接続監視・アラート機能の実装
- 設定ファイルでの接続プール設定可能化

**受け入れ条件**
- [ ] データベース接続プールが正常に動作する
- [ ] 接続タイムアウトが適切に設定されている
- [ ] 接続監視・アラート機能が動作する
- [ ] 設定ファイルから接続プール設定が可能

---

### Epic 3: 認証・認可機能実装

#### なぜやるか
セキュリティの基盤となる認証・認可機能を実装し、適切なアクセス制御を提供する必要がある。

#### 何をやるか（概要）
- セッションクッキーベースの認証実装
- RBAC（ロールベースアクセス制御）実装
- MFA（多要素認証）実装
- IP AllowList機能実装
- パスワードポリシー機能実装

#### 受け入れ条件
- [ ] ユーザーログイン機能が動作する
- [ ] セッション管理が正常に動作する
- [ ] RBACが正常に動作する
- [ ] MFAが正常に動作する
- [ ] IP AllowList機能が正常に動作する
- [ ] パスワードポリシー機能が正常に動作する

#### 詳細
- セッションストレージ: Redis（TTL: 30分）
- パスワードハッシュ化: bcrypt（コスト: 12）
- MFA: TOTP（RFC 6238準拠）
- ロール: service_admin, service_member, customer_admin, customer_member

#### タスク一覧

##### Task 3.1: ユーザー認証機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
ユーザーが安全にログインし、セッションを管理できるようにする必要がある。

**何をやるか（概要）**
- ログインAPI実装（POST /api/v1/auth/login）
- ログアウトAPI実装（POST /api/v1/auth/logout）
- セッション管理実装（Redis使用）
- セッションクッキー設定（HttpOnly, Secure, SameSite）
- パスワードハッシュ化実装（bcrypt）

**受け入れ条件**
- [ ] ログインAPIが正常に動作する
- [ ] ログアウトAPIが正常に動作する
- [ ] セッションがRedisに保存される
- [ ] セッションクッキーが適切に設定される
- [ ] パスワードがbcryptでハッシュ化される

##### Task 3.2: セッション管理機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
セッションの有効期限管理、無効化、更新を適切に行う必要がある。

**何をやるか（概要）**
- セッションタイムアウト機能実装（デフォルト30分）
- セッション無効化機能実装（ログアウト時、パスワード変更時）
- セッション更新機能実装（リクエストのたびに有効期限を更新）
- セッションストレージ（Redis）実装

**受け入れ条件**
- [ ] セッションタイムアウトが正常に動作する
- [ ] セッション無効化が正常に動作する
- [ ] セッション更新が正常に動作する
- [ ] Redisにセッションが適切に保存される

##### Task 3.3: RBAC実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
ユーザーのロールに基づいて適切なアクセス制御を実装する必要がある。

**何をやるか（概要）**
- ロール定義（service_admin, service_member, customer_admin, customer_member）
- 権限マトリクスの実装
- 認可ミドルウェア実装
- リソース単位のアクセス制御実装

**受け入れ条件**
- [ ] 各ロールの権限が適切に実装されている
- [ ] 認可ミドルウェアが正常に動作する
- [ ] リソース単位のアクセス制御が正常に動作する
- [ ] 権限マトリクスがDESIGN.mdの3.4.4.2と一致している

##### Task 3.4: MFA機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
セキュリティを強化するため、多要素認証を実装する必要がある。

**何をやるか（概要）**
- TOTP実装（RFC 6238準拠）
- QRコード生成機能実装
- バックアップコード生成・管理機能実装
- MFA設定フロー実装
- MFA必須設定時の強制リダイレクト実装

**受け入れ条件**
- [ ] TOTPが正常に動作する
- [ ] QRコードが正常に生成される
- [ ] バックアップコードが正常に生成・管理される
- [ ] MFA設定フローが正常に動作する
- [ ] MFA必須設定時の強制リダイレクトが正常に動作する
- [ ] Google Authenticator、Microsoft Authenticatorと互換性がある

##### Task 3.5: IP AllowList機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
IPアドレスベースのアクセス制御を実装し、セキュリティを強化する必要がある。

**何をやるか（概要）**
- IP AllowList登録・編集・削除API実装
- IP/CIDR判定ロジック実装（より具体的な範囲が優先）
- 一時的なIP追加機能実装（適用期限設定）
- AllowList優先ロジック実装（AllowListが絶対優先）

**受け入れ条件**
- [ ] IP AllowList登録・編集・削除APIが正常に動作する
- [ ] IP/CIDR判定ロジックが正常に動作する
- [ ] 一時的なIP追加機能が正常に動作する
- [ ] AllowList優先ロジックが正常に動作する
- [ ] より具体的な範囲が優先される

##### Task 3.6: パスワードポリシー機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
パスワードの強度を確保し、セキュリティを強化する必要がある。

**何をやるか（概要）**
- パスワードポリシー設定API実装
- パスワードバリデーション実装（最小文字数、複雑さ要件）
- パスワード有効期限機能実装
- 過去パスワード再利用制限機能実装
- パスワードポリシー設定画面UI実装

**受け入れ条件**
- [ ] パスワードポリシー設定APIが正常に動作する
- [ ] パスワードバリデーションが正常に動作する
- [ ] パスワード有効期限機能が正常に動作する
- [ ] 過去パスワード再利用制限機能が正常に動作する
- [ ] パスワードポリシー設定画面UIが完成している
- [ ] DECISION_POINTS.mdの2.3の要件を満たしている

---

### Epic 4: 管理画面基本機能実装

#### なぜやるか
サービス管理者と顧客管理者がシステムを管理・設定できる管理画面を実装する必要がある。

#### 何をやるか（概要）
- ダッシュボード実装
- 顧客管理機能実装
- ユーザー管理機能実装
- FQDN管理機能実装
- ログ閲覧機能実装

#### 受け入れ条件
- [ ] ダッシュボードが正常に表示される
- [ ] 顧客管理機能が正常に動作する
- [ ] ユーザー管理機能が正常に動作する
- [ ] FQDN管理機能が正常に動作する
- [ ] ログ閲覧機能が正常に動作する

#### 詳細
- フロントエンド: React/Vue.js/Next.js
- バックエンド: TypeScript（FastAPI/Gin/Express）
- API: REST API（OpenAPI仕様）

#### タスク一覧

##### Task 4.1: ダッシュボード実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
システム全体の状態を一目で把握できるダッシュボードが必要。

**何をやるか（概要）**
- サービス全体管理画面ダッシュボード実装
- 顧客向け管理画面ダッシュボード実装
- 統計情報表示機能実装
- リアルタイムアラート表示機能実装
- パフォーマンスメトリクス表示機能実装

**受け入れ条件**
- [ ] サービス全体管理画面ダッシュボードが正常に表示される
- [ ] 顧客向け管理画面ダッシュボードが正常に表示される
- [ ] 統計情報が正常に表示される
- [ ] リアルタイムアラートが正常に表示される
- [ ] パフォーマンスメトリクスが正常に表示される

##### Task 4.2: 顧客管理機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
顧客の登録・編集・削除、有効/無効化を管理できる機能が必要。

**何をやるか（概要）**
- 顧客登録・編集・削除API実装
- 顧客一覧表示機能実装
- 顧客検索機能実装
- 顧客有効/無効化機能実装
- 顧客管理画面UI実装

**受け入れ条件**
- [ ] 顧客登録・編集・削除APIが正常に動作する
- [ ] 顧客一覧が正常に表示される
- [ ] 顧客検索機能が正常に動作する
- [ ] 顧客有効/無効化機能が正常に動作する
- [ ] 顧客管理画面UIが完成している

##### Task 4.3: ユーザー管理機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
サービス管理ユーザーと顧客ユーザーの管理機能が必要。

**何をやるか（概要）**
- ユーザー作成・編集・削除API実装
- ユーザーロール割り当て機能実装
- ユーザー一覧・検索機能実装
- ユーザー有効/無効化機能実装
- ユーザー管理画面UI実装

**受け入れ条件**
- [ ] ユーザー作成・編集・削除APIが正常に動作する
- [ ] ユーザーロール割り当て機能が正常に動作する
- [ ] ユーザー一覧・検索機能が正常に動作する
- [ ] ユーザー有効/無効化機能が正常に動作する
- [ ] ユーザー管理画面UIが完成している

##### Task 4.4: FQDN管理機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
顧客のFQDNを管理し、WAFエンジンに設定を配信する機能が必要。

**何をやるか（概要）**
- FQDN登録・編集・削除API実装
- FQDN有効/無効化機能実装
- FQDN一覧表示機能実装
- FQDN検索機能実装
- FQDN管理画面UI実装

**受け入れ条件**
- [ ] FQDN登録・編集・削除APIが正常に動作する
- [ ] FQDN有効/無効化機能が正常に動作する
- [ ] FQDN一覧が正常に表示される
- [ ] FQDN検索機能が正常に動作する
- [ ] FQDN管理画面UIが完成している

##### Task 4.5: ログ閲覧機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
ログを検索・閲覧できる機能が必要（詳細は後で決定）。

**何をやるか（概要）**
- ログ検索API実装（ファイルベースの検索API、grepベース）
- ログフィルタリング機能実装
- ログエクスポート機能実装
- ログ閲覧画面UI実装

**受け入れ条件**
- [ ] ログ検索APIが正常に動作する
- [ ] ログフィルタリング機能が正常に動作する
- [ ] ログエクスポート機能が正常に動作する
- [ ] ログ閲覧画面UIが完成している
- [ ] サービス管理者・サービス管理メンバーは全顧客のログを閲覧可能
- [ ] 顧客管理者・顧客メンバーは自社のログのみ閲覧可能

---

### Epic 5: WAFエンジン基盤実装

#### なぜやるか
OpenAppSecをベースとしたWAFエンジンを実装し、WebアプリケーションやAPIに対する攻撃を検知・防御する必要がある。

#### 何をやるか（概要）
- OpenAppSec統合
- Nginx設定管理
- 設定取得・動的更新機能実装
- ログ転送機能実装
- RateLimit機能実装
- GeoIP機能実装
- ヘルスチェック機能実装

#### 受け入れ条件
- [ ] OpenAppSecが正常に統合されている
- [ ] Nginx設定が正常に管理される
- [ ] 設定取得・動的更新機能が正常に動作する
- [ ] ログ転送機能が正常に動作する
- [ ] RateLimit機能が正常に動作する
- [ ] GeoIP機能が正常に動作する
- [ ] ヘルスチェック機能が正常に動作する

#### 詳細
- OpenAppSecベース
- Nginx統合
- Dockerコンテナ化
- 設定取得: ポーリング（デフォルト5分間隔）

#### タスク一覧

##### Task 5.1: OpenAppSec統合
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
OpenAppSecをベースとしてWAF機能を提供する必要がある。

**何をやるか（概要）**
- OpenAppSecのインストール・設定
- Nginxとの統合（共有メモリ使用）
- OpenAppSec設定ファイルの動的更新機能実装
- 設定のバージョン管理機能実装

**受け入れ条件**
- [ ] OpenAppSecが正常にインストールされている
- [ ] Nginxと正常に統合されている
- [ ] 設定ファイルの動的更新が正常に動作する
- [ ] 設定のバージョン管理が正常に動作する

##### Task 5.2: 設定取得・動的更新機能実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
管理APIから設定を取得し、動的に更新する機能が必要。

**何をやるか（概要）**
- 管理APIから設定取得機能実装（ポーリング、デフォルト5分間隔）
- OpenAppSec設定ファイル生成機能実装
- 設定ファイルリロード機能実装（再起動不要）
- 設定のローカルキャッシュ機能実装（TTL: 5分）

**受け入れ条件**
- [ ] 管理APIから設定取得が正常に動作する
- [ ] OpenAppSec設定ファイルが正常に生成される
- [ ] 設定ファイルリロードが正常に動作する（再起動不要）
- [ ] 設定のローカルキャッシュが正常に動作する

##### Task 5.3: ログ転送機能実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
WAFエンジンのログをログ管理サーバに転送する機能が必要。

**何をやるか（概要）**
- Fluentd設定実装
- アクセスログ転送機能実装（JSON形式）
- WAF検知ログ転送機能実装（構造化ログ）
- エラーログ転送機能実装
- ログ転送のリトライ機能実装（指数バックオフ）

**受け入れ条件**
- [ ] Fluentdが正常に動作する
- [ ] アクセスログが正常に転送される
- [ ] WAF検知ログが正常に転送される
- [ ] エラーログが正常に転送される
- [ ] ログ転送のリトライ機能が正常に動作する

##### Task 5.4: RateLimit機能実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
リクエストレート制限を実装し、DDoS攻撃や過剰なリクエストを防御する必要がある。

**何をやるか（概要）**
- Redis連携実装
- スライディングウィンドウアルゴリズム実装
- IPアドレス単位のレート制限実装
- エンドポイント単位のレート制限実装
- 分散環境対応（Redis使用）

**受け入れ条件**
- [ ] Redis連携が正常に動作する
- [ ] スライディングウィンドウアルゴリズムが正常に動作する
- [ ] IPアドレス単位のレート制限が正常に動作する
- [ ] エンドポイント単位のレート制限が正常に動作する
- [ ] 分散環境で正常に動作する

##### Task 5.5: GeoIP機能実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
IPアドレス/CIDRブロックと国単位のアクセス制御を実装する必要がある。

**何をやるか（概要）**
- MaxMindDB統合実装
- IP/CIDR判定ロジック実装（AllowList優先）
- 国コード判定ロジック実装
- GeoIPデータベース自動更新機能実装
- X-Forwarded-For対応実装

**受け入れ条件**
- [ ] MaxMindDBが正常に統合されている
- [ ] IP/CIDR判定ロジックが正常に動作する
- [ ] 国コード判定ロジックが正常に動作する
- [ ] GeoIPデータベース自動更新が正常に動作する
- [ ] X-Forwarded-For対応が正常に動作する

##### Task 5.6: ヘルスチェック機能実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
WAFエンジンの状態を監視し、正常性を確認する機能が必要。

**何をやるか（概要）**
- ヘルスチェックエンドポイント実装（GET /engine/v1/health）
- Nginx状態チェック機能実装
- OpenAppSec状態チェック機能実装
- Redis接続チェック機能実装
- ヘルスチェックレスポンス実装（JSON形式）

**受け入れ条件**
- [ ] ヘルスチェックエンドポイントが正常に動作する
- [ ] Nginx状態チェックが正常に動作する
- [ ] OpenAppSec状態チェックが正常に動作する
- [ ] Redis接続チェックが正常に動作する
- [ ] ヘルスチェックレスポンスがJSON形式で返却される

---

### Epic 6: シグニチャ管理機能実装

#### なぜやるか
シグニチャとシグニチャグループを管理し、WAFエンジンに適用する機能が必要。

#### 何をやるか（概要）
- シグニチャ管理機能実装
- シグニチャグループ管理機能実装
- シグニチャ適用機能実装
- 顧客別シグニチャグループ設定機能実装

#### 受け入れ条件
- [ ] シグニチャ管理機能が正常に動作する
- [ ] シグニチャグループ管理機能が正常に動作する
- [ ] シグニチャ適用機能が正常に動作する
- [ ] 顧客別シグニチャグループ設定機能が正常に動作する

#### 詳細
- シグニチャグループの適用状態: applied, not_applied, customer_decision
- 強制削除機能: 適用中のグループを削除する際の処理

#### タスク一覧

##### Task 6.1: シグニチャ管理機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
シグニチャの一覧表示、有効/無効化、カスタムシグニチャの作成・編集・削除機能が必要。

**何をやるか（概要）**
- シグニチャ一覧表示API実装
- シグニチャ有効/無効化API実装
- カスタムシグニチャ作成・編集・削除API実装
- シグニチャテスト機能実装
- シグニチャ管理画面UI実装

**受け入れ条件**
- [ ] シグニチャ一覧表示APIが正常に動作する
- [ ] シグニチャ有効/無効化APIが正常に動作する
- [ ] カスタムシグニチャ作成・編集・削除APIが正常に動作する
- [ ] シグニチャテスト機能が正常に動作する
- [ ] シグニチャ管理画面UIが完成している

##### Task 6.2: シグニチャグループ管理機能実装（サービス管理者用）
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
複数のシグニチャをグループ化して管理し、一括操作を可能にする必要がある。

**何をやるか（概要）**
- シグニチャグループ作成・編集・削除API実装
- グループへのシグニチャ追加・削除API実装
- グループ適用状態設定API実装（適用/非適用/顧客判断）
- グループ優先度設定機能実装
- 強制削除機能実装（適用中のグループを削除する際の処理）
- シグニチャグループ管理画面UI実装

**受け入れ条件**
- [ ] シグニチャグループ作成・編集・削除APIが正常に動作する
- [ ] グループへのシグニチャ追加・削除APIが正常に動作する
- [ ] グループ適用状態設定APIが正常に動作する
- [ ] グループ優先度設定機能が正常に動作する
- [ ] 強制削除機能が正常に動作する（含まれるシグニチャを個別登録）
- [ ] シグニチャグループ管理画面UIが完成している
- [ ] DECISION_POINTS.mdの1.1の要件を満たしている

##### Task 6.3: シグニチャグループ管理機能実装（顧客管理者用）
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
顧客管理者が「顧客判断」に設定されたシグニチャグループの適用/非適用を設定できる機能が必要。

**何をやるか（概要）**
- 「顧客判断」シグニチャグループ一覧表示API実装
- 顧客全体への適用/非適用設定API実装
- FQDN単位での適用/非適用設定API実装
- 複数FQDNへの一括適用設定API実装
- シグニチャグループ管理画面UI実装（顧客向け）

**受け入れ条件**
- [ ] 「顧客判断」シグニチャグループ一覧表示APIが正常に動作する
- [ ] 顧客全体への適用/非適用設定APIが正常に動作する
- [ ] FQDN単位での適用/非適用設定APIが正常に動作する
- [ ] 複数FQDNへの一括適用設定APIが正常に動作する
- [ ] シグニチャグループ管理画面UIが完成している

##### Task 6.4: シグニチャ適用機能実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
管理画面で設定されたシグニチャグループをWAFエンジンに適用する機能が必要。

**何をやるか（概要）**
- シグニチャグループ適用ロジック実装
- 適用状態の優先順位処理実装（サービス設定 > 顧客設定）
- シグニチャ適用履歴管理機能実装
- シグニチャ適用状態の同期機能実装

**受け入れ条件**
- [ ] シグニチャグループ適用ロジックが正常に動作する
- [ ] 適用状態の優先順位処理が正常に動作する
- [ ] シグニチャ適用履歴が正常に管理される
- [ ] シグニチャ適用状態の同期が正常に動作する

##### Task 6.5: シグニチャ候補承認機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
シグニチャ収集機能で生成されたシグニチャ候補を承認する機能が必要。

**何をやるか（概要）**
- シグニチャ候補一覧表示API実装
- シグニチャ候補承認API実装
- シグニチャ候補却下API実装
- シグニチャ候補承認画面UI実装

**受け入れ条件**
- [ ] シグニチャ候補一覧表示APIが正常に動作する
- [ ] シグニチャ候補承認APIが正常に動作する
- [ ] シグニチャ候補却下APIが正常に動作する
- [ ] シグニチャ候補承認画面UIが完成している

---

### Epic 7: シグニチャ収集機能実装

#### なぜやるか
商用WAF機能や脆弱性情報を元に新規シグニチャを自動生成し、検証して承認する機能が必要。

#### 何をやるか（概要）
- シグニチャ生成機能実装
- シグニチャ検証機能実装
- バッチ処理機能実装
- シグニチャ候補管理機能実装

#### 受け入れ条件
- [ ] シグニチャ生成機能が正常に動作する
- [ ] シグニチャ検証機能が正常に動作する
- [ ] バッチ処理機能が正常に動作する
- [ ] シグニチャ候補管理機能が正常に動作する

#### 詳細
- 検証バッチ: 毎日2時（JST、デフォルト）
- 再検証: 30日間毎日検証
- 30日経過後: 自動削除
- 再検証で良好な結果: 自動承認せず、サービス管理者の承認が必要

#### タスク一覧

##### Task 7.1: シグニチャ生成機能実装
**リポジトリ**: MrWebDefence-SignatureCollector

**なぜやるか**
商用WAF機能や脆弱性情報を元に新規シグニチャを自動生成する機能が必要。

**何をやるか（概要）**
- 商用WAF機能分析ロジック実装
- 脆弱性情報収集ロジック実装（CVE、セキュリティアドバイザリ）
- シグニチャテンプレートからの生成機能実装
- カスタムシグニチャルール作成機能実装
- シグニチャメタデータ管理機能実装

**受け入れ条件**
- [ ] 商用WAF機能分析ロジックが正常に動作する
- [ ] 脆弱性情報収集ロジックが正常に動作する
- [ ] シグニチャテンプレートからの生成が正常に動作する
- [ ] カスタムシグニチャルール作成が正常に動作する
- [ ] シグニチャメタデータ管理が正常に動作する

##### Task 7.2: シグニチャ検証機能実装
**リポジトリ**: MrWebDefence-SignatureCollector

**なぜやるか**
生成されたシグニチャを検証し、誤検知率・検知率・パフォーマンス影響を評価する必要がある。

**何をやるか（概要）**
- 過去ログとの照合ロジック実装
- 誤検知率計算ロジック実装
- 検知率計算ロジック実装
- パフォーマンス影響評価ロジック実装
- 検証結果のJSON形式保存機能実装

**受け入れ条件**
- [ ] 過去ログとの照合ロジックが正常に動作する
- [ ] 誤検知率計算ロジックが正常に動作する
- [ ] 検知率計算ロジックが正常に動作する
- [ ] パフォーマンス影響評価ロジックが正常に動作する
- [ ] 検証結果がJSON形式で保存される

##### Task 7.3: バッチ処理機能実装
**リポジトリ**: MrWebDefence-SignatureCollector

**なぜやるか**
毎日決まった時間にシグニチャ候補を検証するバッチ処理機能が必要。

**何をやるか（概要）**
- バッチスケジューラー実装（cronまたはスケジューラーライブラリ）
- シグニチャ候補取得機能実装
- バッチ実行フロー実装（検証→結果更新→30日経過候補削除）
- バッチのリトライ機能実装（指数バックオフ）
- バッチ処理の失敗通知機能実装

**受け入れ条件**
- [ ] バッチスケジューラーが正常に動作する
- [ ] シグニチャ候補取得が正常に動作する
- [ ] バッチ実行フローが正常に動作する
- [ ] バッチのリトライ機能が正常に動作する（5回、指数バックオフ）
- [ ] バッチ処理の失敗通知が正常に動作する
- [ ] デフォルト実行時間: 毎日2時（JST）
- [ ] 30日経過後の自動削除が正常に動作する
- [ ] DECISION_POINTS.mdの1.2、1.4の要件を満たしている

##### Task 7.4: シグニチャ候補管理機能実装
**リポジトリ**: MrWebDefence-SignatureCollector

**なぜやるか**
シグニチャ候補プールを管理し、承認ワークフローを実装する必要がある。

**何をやるか（概要）**
- シグニチャ候補プール管理機能実装
- ステータス管理機能実装（pending, approved, rejected, deleted）
- 検証日時管理機能実装（first_verified_at, last_verified_at）
- 30日経過後の自動削除ロジック実装
- 削除履歴記録機能実装

**受け入れ条件**
- [ ] シグニチャ候補プール管理が正常に動作する
- [ ] ステータス管理が正常に動作する
- [ ] 検証日時管理が正常に動作する
- [ ] 30日経過後の自動削除が正常に動作する
- [ ] 削除履歴が正常に記録される

---

### Epic 8: ログ管理サーバ実装

#### なぜやるか
WAFエンジンから転送されるログを収集・保存・分析するログ管理サーバが必要。

#### 何をやるか（概要）
- ログ収集機能実装
- ログ保存機能実装
- ログ転送機能実装
- ログ分析機能実装

#### 受け入れ条件
- [ ] ログ収集機能が正常に動作する
- [ ] ログ保存機能が正常に動作する
- [ ] ログ転送機能が正常に動作する
- [ ] ログ分析機能が正常に動作する

#### 詳細
- ログ収集: Fluentd/Fluent Bit
- ログ保存: ローカルストレージまたはS3
- ログアーカイブ: gz形式で圧縮、1年保持

#### タスク一覧

##### Task 8.1: ログ収集機能実装
**リポジトリ**: MrWebDefence-LogServer

**なぜやるか**
WAFエンジンから転送されるログを受信し、パース・正規化する機能が必要。

**何をやるか（概要）**
- Fluentd/Fluent Bit設定実装
- ログ受信エンドポイント実装（HTTP、TCP）
- ログパース・正規化ロジック実装
- ログタイムスタンプ補正機能実装
- ログバッファリング機能実装

**受け入れ条件**
- [ ] Fluentd/Fluent Bitが正常に動作する
- [ ] ログ受信エンドポイントが正常に動作する
- [ ] ログパース・正規化が正常に動作する
- [ ] ログタイムスタンプ補正が正常に動作する
- [ ] ログバッファリングが正常に動作する

##### Task 8.2: ログ保存機能実装
**リポジトリ**: MrWebDefence-LogServer

**なぜやるか**
収集したログをローカルストレージまたはS3に保存する機能が必要。

**何をやるか（概要）**
- ローカルストレージ保存機能実装
- S3保存機能実装（オプション）
- ログ圧縮・アーカイブ機能実装（gz形式）
- ログ保持期間管理機能実装
- ログ自動削除機能実装（1年経過後）

**受け入れ条件**
- [ ] ローカルストレージ保存が正常に動作する
- [ ] S3保存が正常に動作する（オプション）
- [ ] ログ圧縮・アーカイブが正常に動作する（gz形式）
- [ ] ログ保持期間管理が正常に動作する
- [ ] ログ自動削除が正常に動作する（1年経過後）
- [ ] DECISION_POINTS.mdの3.3の要件を満たしている

##### Task 8.3: ログ転送機能実装
**リポジトリ**: MrWebDefence-LogServer

**なぜやるか**
外部ログ管理システム（Splunk、Datadog等）やクラウドストレージ（S3、GCS等）にログを転送する機能が必要。

**何をやるか（概要）**
- 外部システムへの転送機能実装（Splunk、Datadog等）
- クラウドストレージへの転送機能実装（S3、GCS等）
- 転送のリトライ機能実装（指数バックオフ）
- 転送の優先度設定機能実装
- 転送先の動的変更機能実装

**受け入れ条件**
- [ ] 外部システムへの転送が正常に動作する
- [ ] クラウドストレージへの転送が正常に動作する
- [ ] 転送のリトライ機能が正常に動作する
- [ ] 転送の優先度設定が正常に動作する
- [ ] 転送先の動的変更が正常に動作する

##### Task 8.4: ログ分析機能実装
**リポジトリ**: MrWebDefence-LogServer

**なぜやるか**
ログを分析し、攻撃パターン、検知漏れ、誤検知を検出する機能が必要。

**何をやるか（概要）**
- 攻撃分析ロジック実装（攻撃タイプ別集計、攻撃元IP分析、時系列分析）
- 検知漏れ分析ロジック実装（異常パターン検出、既知攻撃パターン照合）
- 誤検知分析ロジック実装（誤検知可能性抽出、誤検知パターン分析）
- 分析結果保存機能実装
- 分析レポート生成機能実装

**受け入れ条件**
- [ ] 攻撃分析ロジックが正常に動作する
- [ ] 検知漏れ分析ロジックが正常に動作する
- [ ] 誤検知分析ロジックが正常に動作する
- [ ] 分析結果が正常に保存される
- [ ] 分析レポートが正常に生成される

---

### Epic 9: 通知機能実装

#### なぜやるか
イベント発生時に通知を送信し、管理者や顧客に重要な情報を伝える機能が必要。

#### 何をやるか（概要）
- 通知チャネル実装（メール、Slack）
- 通知ルール実装
- 通知重複防止機能実装
- 通知リトライ機能実装
- 通知履歴管理機能実装

#### 受け入れ条件
- [ ] 通知チャネルが正常に動作する
- [ ] 通知ルールが正常に動作する
- [ ] 通知重複防止機能が正常に動作する
- [ ] 通知リトライ機能が正常に動作する
- [ ] 通知履歴管理機能が正常に動作する

#### 詳細
- 通知チャネル: メール、Slack、Webhook（拡張）
- 通知優先度: Critical, Medium, Low
- 重複防止期間: デフォルト10分間
- リトライ: 5回、指数バックオフ

#### タスク一覧

##### Task 9.1: 通知チャネル実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
メール、Slack等の通知チャネルを実装し、イベント発生時に通知を送信する必要がある。

**何をやるか（概要）**
- メール通知機能実装（SMTP）
- Slack通知機能実装（Webhook API）
- Webhook通知機能実装（拡張）
- 通知チャネル設定API実装
- 通知チャネル管理画面UI実装

**受け入れ条件**
- [ ] メール通知が正常に動作する
- [ ] Slack通知が正常に動作する
- [ ] Webhook通知が正常に動作する（拡張）
- [ ] 通知チャネル設定APIが正常に動作する
- [ ] 通知チャネル管理画面UIが完成している

##### Task 9.2: 通知ルール実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
イベントタイプ、優先度、顧客に基づいて通知ルールを設定する機能が必要。

**何をやるか（概要）**
- 通知ルール設定API実装
- イベントタイプ定義（attack_detected, system_error, batch_failed等）
- 優先度定義（Critical, Medium, Low）
- 通知条件定義機能実装
- 通知ルール管理画面UI実装

**受け入れ条件**
- [ ] 通知ルール設定APIが正常に動作する
- [ ] イベントタイプが適切に定義されている
- [ ] 優先度が適切に定義されている
- [ ] 通知条件定義が正常に動作する
- [ ] 通知ルール管理画面UIが完成している

##### Task 9.3: 通知重複防止機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
同じイベントの重複通知を防ぎ、通知の過多を避ける必要がある。

**何をやるか（概要）**
- 重複防止期間管理機能実装（デフォルト10分間）
- 重複判定ロジック実装（イベントタイプ + イベントID + 顧客ID）
- 優先度管理機能実装（顧客設定 > サービス設定 > デフォルト）
- Redisを使用した重複防止実装

**受け入れ条件**
- [ ] 重複防止期間管理が正常に動作する
- [ ] 重複判定ロジックが正常に動作する
- [ ] 優先度管理が正常に動作する
- [ ] Redisを使用した重複防止が正常に動作する
- [ ] DECISION_POINTS.mdの3.1の要件を満たしている

##### Task 9.4: 通知リトライ機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
通知送信が失敗した場合にリトライし、確実に通知を送信する必要がある。

**何をやるか（概要）**
- 指数バックオフ実装（5秒、10秒、20秒、40秒、80秒）
- リトライ回数管理機能実装（最大5回）
- 失敗記録機能実装
- 通知履歴管理機能実装

**受け入れ条件**
- [ ] 指数バックオフが正常に動作する
- [ ] リトライ回数管理が正常に動作する（最大5回）
- [ ] 失敗記録が正常に動作する
- [ ] 通知履歴管理が正常に動作する
- [ ] DECISION_POINTS.mdの3.1の要件を満たしている

##### Task 9.5: 通知履歴管理機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
通知の送信履歴を管理し、確認できる機能が必要。

**何をやるか（概要）**
- 通知履歴保存機能実装（notificationsテーブル）
- 通知履歴検索機能実装（顧客、イベントタイプ、優先度で検索）
- 通知履歴保持期間管理機能実装（1年、デフォルト）
- 通知履歴閲覧画面UI実装

**受け入れ条件**
- [ ] 通知履歴保存が正常に動作する
- [ ] 通知履歴検索が正常に動作する
- [ ] 通知履歴保持期間管理が正常に動作する
- [ ] 通知履歴閲覧画面UIが完成している
- [ ] サービス管理者・サービス管理メンバーは全顧客の通知を確認可能
- [ ] 顧客管理者・顧客メンバーは自社の通知のみ確認可能

---

### Epic 10: バックアップ・リストア機能実装

#### なぜやるか
データベースの定期バックアップとリストア機能を実装し、データの安全性を確保する必要がある。

#### 何をやるか（概要）
- バックアップ機能実装（ローカル、リモート）
- バックアップ検証機能実装
- リストア機能実装
- バックアップスケジュール管理機能実装

#### 受け入れ条件
- [ ] バックアップ機能が正常に動作する
- [ ] バックアップ検証機能が正常に動作する
- [ ] リストア機能が正常に動作する
- [ ] バックアップスケジュール管理機能が正常に動作する

#### 詳細
- バックアップ実行時間: デフォルト午前3時（JST）
- バックアップ保存先: ローカル、AWS Aurora/RDS Snapshot（オプション）
- バックアップ暗号化: AES-256

#### タスク一覧

##### Task 10.1: ローカルバックアップ機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
データベースをローカルストレージにバックアップする機能が必要。

**何をやるか（概要）**
- mysqldumpを使用したバックアップ機能実装
- バックアップファイル圧縮機能実装（gzip）
- バックアップファイル保存機能実装
- バックアップスケジュール管理機能実装

**受け入れ条件**
- [ ] mysqldumpを使用したバックアップが正常に動作する
- [ ] バックアップファイル圧縮が正常に動作する（gzip）
- [ ] バックアップファイル保存が正常に動作する
- [ ] バックアップスケジュール管理が正常に動作する
- [ ] デフォルト実行時間: 午前3時（JST）

##### Task 10.2: リモートバックアップ機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
AWS Aurora/RDS Snapshotを取得する機能を実装し、クラウド環境でのバックアップを可能にする。

**何をやるか（概要）**
- AWS RDS API連携実装
- Snapshot取得機能実装
- Snapshotスケジュール設定機能実装
- クラウドプロバイダー設定機能実装

**受け入れ条件**
- [ ] AWS RDS API連携が正常に動作する
- [ ] Snapshot取得が正常に動作する
- [ ] Snapshotスケジュール設定が正常に動作する
- [ ] クラウドプロバイダー設定が正常に動作する
- [ ] DECISION_POINTS.mdの3.2の要件を満たしている

##### Task 10.3: バックアップ検証機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
バックアップの整合性を検証し、有効性を確認する必要がある。

**何をやるか（概要）**
- ローカルバックアップのchecksum検証機能実装（sha256sum）
- リモートバックアップの存在確認機能実装（AWS RDS API）
- リストアテスト機能実装（定期的に、月次推奨）
- 検証結果ログ記録機能実装

**受け入れ条件**
- [ ] ローカルバックアップのchecksum検証が正常に動作する
- [ ] リモートバックアップの存在確認が正常に動作する
- [ ] リストアテストが正常に動作する（定期的に、月次推奨）
- [ ] 検証結果ログ記録が正常に動作する
- [ ] DECISION_POINTS.mdの3.2の要件を満たしている

##### Task 10.4: バックアップ暗号化機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
バックアップファイルを暗号化し、セキュリティを強化する必要がある。

**何をやるか（概要）**
- バックアップ暗号化機能実装（AES-256）
- 暗号化キー管理機能実装（Key管理システム連携）
- ローカル・リモート両方のバックアップ暗号化実装

**受け入れ条件**
- [ ] バックアップ暗号化が正常に動作する（AES-256）
- [ ] 暗号化キー管理が正常に動作する
- [ ] ローカル・リモート両方のバックアップが暗号化される
- [ ] DECISION_POINTS.mdの3.2の要件を満たしている

##### Task 10.5: リストア機能実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
バックアップからデータベースをリストアする機能が必要。

**何をやるか（概要）**
- リストア手順実装
- リストア検証機能実装（データ整合性、アプリケーション動作確認）
- リストアスクリプト実装

**受け入れ条件**
- [ ] リストア手順が正常に動作する
- [ ] リストア検証が正常に動作する
- [ ] リストアスクリプトが完成している
- [ ] リストア手順がドキュメント化されている

---

### Epic 11: 監視・メトリクス機能実装

#### なぜやるか
システムの状態を監視し、メトリクスを収集して可視化する機能が必要。

#### 何をやるか（概要）
- サイドカー方式の監視アーキテクチャ実装
- Prometheus Exporter実装
- Datadog Agent実装（オプション）
- メトリクス収集機能実装
- ログ監視機能実装

#### 受け入れ条件
- [ ] サイドカー方式の監視アーキテクチャが実装されている
- [ ] Prometheus Exporterが正常に動作する
- [ ] Datadog Agentが正常に動作する（オプション）
- [ ] メトリクス収集機能が正常に動作する
- [ ] ログ監視機能が正常に動作する

#### 詳細
- 監視方式: サイドカー方式
- メトリクス形式: Prometheus形式
- 監視対象: WAFエンジン、管理画面、ログ管理サーバ

#### タスク一覧

##### Task 11.1: サイドカー監視アーキテクチャ実装
**リポジトリ**: 全リポジトリ

**なぜやるか**
各コンポーネントにサイドカーを配置し、監視情報を収集できるようにする必要がある。

**何をやるか（概要）**
- サイドカーコンテナ設計
- Prometheus Exporter形式のサイドカーテンプレート作成
- Datadog Agent形式のサイドカーテンプレート作成
- サイドカー設定ファイル作成

**受け入れ条件**
- [ ] サイドカーコンテナ設計が完成している
- [ ] Prometheus Exporter形式のサイドカーテンプレートが完成している
- [ ] Datadog Agent形式のサイドカーテンプレートが完成している
- [ ] サイドカー設定ファイルが完成している
- [ ] DESIGN.mdの3.12.1の要件を満たしている

##### Task 11.2: WAFエンジンメトリクス収集実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
WAFエンジンのメトリクス（リクエスト数、ブロック数、エラー数等）を収集する必要がある。

**何をやるか（概要）**
- Nginxベースのメトリクス収集実装
- Errorログメトリクス収集実装（server単位、vhost単位）
- Fluentdメトリクス収集実装
- メトリクスタグ付与機能実装（fqdn, vhost, server等）

**受け入れ条件**
- [ ] Nginxベースのメトリクス収集が正常に動作する
- [ ] Errorログメトリクス収集が正常に動作する
- [ ] Fluentdメトリクス収集が正常に動作する
- [ ] メトリクスタグが適切に付与される

##### Task 11.3: 管理画面メトリクス収集実装
**リポジトリ**: MrWebDefence-Console

**なぜやるか**
管理画面のメトリクス（APIリクエスト数、レスポンス時間、エラー数等）を収集する必要がある。

**何をやるか（概要）**
- Nginxベースのメトリクス収集実装
- アプリケーションメトリクス収集実装
- ログメトリクス収集実装
- メトリクスタグ付与機能実装（service, endpoint等）

**受け入れ条件**
- [ ] Nginxベースのメトリクス収集が正常に動作する
- [ ] アプリケーションメトリクス収集が正常に動作する
- [ ] ログメトリクス収集が正常に動作する
- [ ] メトリクスタグが適切に付与される

##### Task 11.4: ログ管理サーバメトリクス収集実装
**リポジトリ**: MrWebDefence-LogServer

**なぜやるか**
ログ管理サーバのメトリクス（Fluentdメトリクス、ログ監視等）を収集する必要がある。

**何をやるか（概要）**
- Fluentdメトリクス収集実装
- ログ監視メトリクス収集実装
- メトリクスタグ付与機能実装（log_type, source等）

**受け入れ条件**
- [ ] Fluentdメトリクス収集が正常に動作する
- [ ] ログ監視メトリクス収集が正常に動作する
- [ ] メトリクスタグが適切に付与される

##### Task 11.5: 異常パターン検知機能実装（ローカル環境）
**リポジトリ**: MrWebDefence-LogServer

**なぜやるか**
ローカル環境で異常なアクセスパターンを検知し、Slackに通知する機能が必要。

**何をやるか（概要）**
- Fluentdプラグイン/スクリプトによる異常パターン検知実装
- Slack通知インターフェイス実装
- 管理画面からのSlack通知設定機能実装

**受け入れ条件**
- [ ] 異常パターン検知が正常に動作する
- [ ] Slack通知が正常に動作する
- [ ] 管理画面からのSlack通知設定が正常に動作する
- [ ] DECISION_POINTS.mdの6.2の要件を満たしている

---

### Epic 12: テスト環境構築

#### なぜやるか
開発環境、CI環境、テスト環境を構築し、品質を保証する必要がある。

#### 何をやるか（概要）
- Local環境構築（Docker Compose）
- CI環境構築（GitHub Actions）
- テストデータ管理
- テストスクリプト実装

#### 受け入れ条件
- [ ] Local環境が正常に動作する
- [ ] CI環境が正常に動作する
- [ ] テストデータが適切に管理されている
- [ ] テストスクリプトが正常に動作する

#### 詳細
- Local環境: Docker Compose
- CI環境: GitHub Actions
- テストカバレッジ: 全体80%以上、個別モジュール70%以上

#### タスク一覧

##### Task 12.1: Local環境構築（Docker Compose）
**リポジトリ**: 全リポジトリ

**なぜやるか**
開発者がローカル環境でシステム全体を動作させ、開発・テストを行う必要がある。

**何をやるか（概要）**
- Docker Compose設定ファイル作成
- 各コンポーネントのDockerfile作成
- 環境変数設定ファイル作成
- データベース初期化スクリプト作成
- 起動・停止スクリプト作成

**受け入れ条件**
- [ ] Docker Compose設定ファイルが完成している
- [ ] 各コンポーネントのDockerfileが完成している
- [ ] 環境変数設定ファイルが完成している
- [ ] データベース初期化スクリプトが正常に動作する
- [ ] 起動・停止スクリプトが正常に動作する
- [ ] Local環境でシステム全体が正常に動作する

##### Task 12.2: CI環境構築（GitHub Actions）
**リポジトリ**: 全リポジトリ

**なぜやるか**
コードの品質を保証し、自動的にテストを実行するCI環境が必要。

**何をやるか（概要）**
- GitHub Actionsワークフロー作成
- ユニットテスト実行設定
- E2Eテスト実行設定
- Lint実行設定
- Buildテスト実行設定

**受け入れ条件**
- [ ] GitHub Actionsワークフローが正常に動作する
- [ ] ユニットテストが自動実行される
- [ ] E2Eテストが自動実行される
- [ ] Lintが自動実行される
- [ ] Buildテストが自動実行される

##### Task 12.3: テストデータ管理
**リポジトリ**: 全リポジトリ

**なぜやるか**
テストデータを適切に管理し、テストの再現性を確保する必要がある。

**何をやるか（概要）**
- テストデータファイル作成
- テストデータのGit管理
- テストデータ投入スクリプト作成
- テストデータクリーンアップスクリプト作成

**受け入れ条件**
- [ ] テストデータファイルが完成している
- [ ] テストデータがGitで管理されている
- [ ] テストデータ投入スクリプトが正常に動作する
- [ ] テストデータクリーンアップスクリプトが正常に動作する

##### Task 12.4: 統合テストスクリプト実装
**リポジトリ**: MrWebDefence-Design

**なぜやるか**
ビッグバン型の統合テストを実行するスクリプトが必要。

**何をやるか（概要）**
- 統合テスト実行スクリプト作成
- テスト環境セットアップスクリプト作成
- テスト結果レポート生成機能実装

**受け入れ条件**
- [ ] 統合テスト実行スクリプトが正常に動作する
- [ ] テスト環境セットアップスクリプトが正常に動作する
- [ ] テスト結果レポートが正常に生成される
- [ ] DECISION_POINTS.mdの10.1の要件を満たしている

##### Task 12.5: パフォーマンステスト実装
**リポジトリ**: MrWebDefence-Engine

**なぜやるか**
WAFエンジンのパフォーマンス要件（平均10ms以下、P95: 50ms以下）を満たしているか確認する必要がある。

**何をやるか（概要）**
- パフォーマンステストツール設定（Apache Bench、wrk等）
- パフォーマンステストシナリオ作成
- パフォーマンステスト実行スクリプト作成
- パフォーマンステスト結果レポート生成機能実装

**受け入れ条件**
- [ ] パフォーマンステストツールが正常に動作する
- [ ] パフォーマンステストシナリオが完成している
- [ ] パフォーマンステスト実行スクリプトが正常に動作する
- [ ] パフォーマンステスト結果レポートが正常に生成される
- [ ] WAFエンジンのパフォーマンス要件を満たしている
- [ ] DECISION_POINTS.mdの10.1の要件を満たしている

---

## 実装順序の推奨

### Phase 1: 基盤構築
1. Epic 1: システムアーキテクチャ設計
2. Epic 2: データベース設計・実装
3. Epic 12: テスト環境構築（並行）

### Phase 2: 認証・認可・基本機能
4. Epic 3: 認証・認可機能実装
5. Epic 4: 管理画面基本機能実装

### Phase 3: WAFエンジン・シグニチャ
6. Epic 5: WAFエンジン基盤実装
7. Epic 6: シグニチャ管理機能実装
8. Epic 7: シグニチャ収集機能実装

### Phase 4: ログ・通知・運用機能
9. Epic 8: ログ管理サーバ実装
10. Epic 9: 通知機能実装
11. Epic 10: バックアップ・リストア機能実装
12. Epic 11: 監視・メトリクス機能実装

---

## 注意事項

1. **依存関係**: 各Epic・タスクには依存関係があるため、実装順序に注意する
2. **受け入れ条件**: 各タスクの受け入れ条件を満たすまで完了としない
3. **ドキュメント更新**: 実装と同時にDESIGN.md、SPECIFICATION.mdを更新する
4. **テスト**: 各タスク完了時にユニットテスト、統合テストを実施する
5. **コードレビュー**: 各タスク完了時にコードレビューを実施する

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0 | 2024年 | 初版作成 | - |

