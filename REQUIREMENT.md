
## 要望
- WAF（WebApplicationFirewall）エンジンを作成したいです
- エンジンはOpenAppSec（https://github.com/openappsec/openappsec）をベースに作成する

- エンジン
　- 機能は以下の通り
    - MUST
      - WAF
      - WAAP(Web Application API Protection)
      - RateLimit
      - GeoIP Base Protection
        - IP/Cyder
        - Country
    - WANT
      - Anti-Bot
      - IPS
      - File Security

- 管理画面
  - 目的：エンジンを稼働させるための設定を行ううことができる
  - 種類
    - サービス全体管理
      - このWAFサービス全体に関わる設定、作業の実施、全体の状態監視、管理を行うことを目的とする。作業者はWAF管理者を想定する
    - 顧客向け管理画面
      - 主に対象FQDNに関わる設定、作業の実施、状態監視、管理を行うことを目的とする。作業者はWAF管理者を想定する
      - 1顧客は複数のFQDNを登録することができ、それぞれのFQDNに対して個別の設定を行うことができる
      - 希望をすれば、複数のFQDNを同一の設定を登録することができる


## システム的な要求
- WAFエンジン
  - Docker上のnginxとOpenAppSecで稼働する
  - ログはFQDNごとに、WEBサーバの各種ログ、WAFの各種ログを取得することができ、ログ管理サーバに転送される仕組みを持つ
  - 今回のスコープ外ではあるが、LB等を使用することでスケールアウトでキャパシティを追加することができる。この際、RateLimitはスケールされたコンピュータ全体で設定を行う仕組みを持つ
  


- 管理機能（管理画面）
  - 軽量で使用しやすい言語、フレームワークを使用したモダンな構成とする
  - 必ずログインをして利用する。ユーザの種類は、サービス管理者、サービス管理メンバー、顧客管理者、顧客メンバーの4種類とする
    - サービス管理者：サービス全体管理の管理者。すべての機能を実施できる
    - サービス管理メンバー：サービス管理メンバーの管理、ログ管理を除く、すべての機能を実施できる
    - 顧客管理者：顧客向け管理画面の管理者。顧客メンバーの作成を行うことができる。その他は顧客メンバーとできることは同じ
    - 顧客メンバー：顧客向け管理画面の作業を行うことができる。
  - シグニチャ収集機能で提案されたシグニチャは、投入シグニチャ候補画面で確認できる（サービス管理者のみ）。ここで確認OKの判断したシグニチャは、稼働する全WAFエンジンに適用を開始する

- ログ管理サーバ
  - WAFエンジンから転送されるログを取り扱うことができる。小規模であればローカルに保管し、規模が大きい倍は他のログ管理機能、S3等のストレージに転送する機能を持つ
  - WAF検知ログから、発生している攻撃の分析を行うことができる（分析の種類は別途検討。提案OK）
  - WEBサーバログ、WAFログ全体から、検知できていないログ、誤検知の可能性を分析することができる

- シグニチャ収集機能
  - 商用WAF機能、各種脆弱性情報を元に新規のシグニチャの可能性を作成できる
  - 新規に作成したシグニチャは、過去のWEBサーバ、WAFログログを検査し、投入すべきかどうかを確認できる。これは毎日決まった時間に確認を行うバッチが稼働する。
  - また１回投入すべきではないと判断したシグニチャも30日間は保管し、毎日検査を行う
  - 検査の結果、WAF全体のシグニチャに投入すべきであると判断したものは、投入シグニチャ候補プールに投入をする。これはサービス全体管理が麺の投入シグニチャ候補画面で確認できる

